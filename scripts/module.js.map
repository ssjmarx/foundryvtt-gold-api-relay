{"version":3,"file":"module.js","sources":["../../src/ts/systems/dnd5e.ts","../../src/ts/systems/a5e.ts","../../src/ts/systems.ts","../../src/ts/constants.ts","../../src/ts/utils/logger.ts","../../src/ts/types.ts","../../src/ts/network/webSocketManager.ts","../../src/ts/network/routers/baseRouter.ts","../../src/ts/network/routers/pingPong.ts","../../src/ts/utils/serialization.ts","../../src/ts/network/routers/entity.ts","../../src/ts/network/routers/encounter.ts","../../src/ts/network/routers/roll.ts","../../src/ts/utils/search.ts","../../src/ts/network/routers/search.ts","../../src/ts/network/routers/structure.ts","../../src/ts/utils/version.ts","../../src/ts/network/routers/sheet.ts","../../src/ts/network/routers/macro.ts","../../src/ts/network/routers/utility.ts","../../src/ts/network/routers/fileSystem.ts","../../src/ts/network/routers/dnd5e.ts","../../src/ts/network/routers/all.ts","../../src/ts/network/webSocketEndpoints.ts","../../src/ts/module.ts"],"sourcesContent":["import { IRestApiSystem } from \"./IRestApiSystem\";\n\nexport class dnd5e implements IRestApiSystem {\n    ACTOR_CURRENCY_ATTRIBUTE = \"system.currency\";\n    // TODO ADD SOME MORE THINGS FOR SPECIALIZE FUNCTION BASED ON SYSTEM ???\n}; ","import { IRestApiSystem } from \"./IRestApiSystem\";\n\nexport class a5e implements IRestApiSystem {\n    ACTOR_CURRENCY_ATTRIBUTE = \"system.currency\";\n    // TODO ADD SOME MORE THINGS FOR SPECIALIZE FUNCTION BASED ON SYSTEM ???\n}; ","// ↓ IMPORT SYSTEMS HERE ↓\n// import {dnd4e} from \"./systems/dnd4e\";\nimport {dnd5e} from \"./systems/dnd5e\";\n// import {pf1} from \"./systems/pf1\";\n// import {pf2e} from \"./systems/pf2e\";\n// import {ds4} from \"./systems/ds4\";\n// import {d35e} from \"./systems/d35e\";\n// import {sfrpg} from \"./systems/sfrpg\";\n// import {swade} from \"./systems/swade\";\n// import {tormenta20} from \"./systems/tormenta20\";\n// import {wfrp4e} from \"./systems/wfrp4e\";\n// import {splittermond} from \"./systems/splittermond\";\n// import {forbiddenLands} from \"./systems/forbidden-lands\";\n// import {icrpg} from \"./systems/icrpg\";\n// import {swse} from \"./systems/swse\";\n// import {sw5e} from \"./systems/sw5e\";\n// import {sw5e203} from \"./systems/sw5e-2.0.3.2.3.8\";\n// import {fallout} from \"./systems/fallout\";\n// import {cyberpunkRedCore} from \"./systems/cyberpunk-red-core\";\n// import {knave} from \"./systems/knave\";\n// import {t2k4e} from \"./systems/t2k4e\";\n// import {yzecoriolis} from \"./systems/yzecoriolis\";\n// import {kamigakari} from \"./systems/kamigakari\";\n// import {symbaroum} from \"./systems/symbaroum\";\n// import {wwn} from \"./systems/wwn\";\n// import {cyphersystem} from \"./systems/cyphersystem\";\n// import {ptu} from \"./systems/ptu\";\n// import {dcc} from \"./systems/dcc\";\nimport {a5e} from \"./systems/a5e\";\n// import {darkHeresy2e} from \"./systems/dark-heresy\";\n// import {naheulbeuk} from \"./systems/naheulbeuk\";\n// import {icrpgme} from \"./systems/icrpgme\";\n// import {bladeRunner} from \"./systems/blade-runner\";\n// import {alienrpg} from \"./systems/alienrpg\";\n// import {pirateborg} from \"./systems/pirateborg\";\n// import {starwarsffg} from \"./systems/starwarsffg\";\n// ↑ IMPORT SYSTEMS HERE ↑\n\n/**\n * NOTE: YOUR PULL REQUEST WILL NOT BE ACCEPTED IF YOU DO NOT\n * FOLLOW THE CONVENTION IN THE D&D 5E SYSTEM FILE\n */\nexport const SYSTEMS = {\n    SUPPORTED_SYSTEMS:<any>{\n        // ↓ ADD SYSTEMS HERE ↓\n        // \"alienrpg\": {\n        //   \"latest\": alienrpg\n        // },\n        // \"dnd4e\": {\n        //   \"latest\": dnd4e\n        // },\n        dnd5e: {\n            latest: dnd5e,\n        },\n        // \"pf1\": {\n        //   \"latest\": pf1\n        // },\n        // \"pf2e\": {\n        //   \"latest\": pf2e\n        // },\n        // \"ds4\": {\n        //   \"latest\": ds4\n        // },\n        // \"d35e\": {\n        //   \"latest\": d35e\n        // },\n        // \"blade-runner\": {\n        //   \"latest\": bladeRunner\n        // },\n        // \"sfrpg\": {\n        //   \"latest\": sfrpg\n        // },\n        // \"swade\": {\n        //   \"latest\": swade\n        // },\n        // \"tormenta20\": {\n        //   \"latest\": tormenta20\n        // },\n        // \"wfrp4e\": {\n        //   \"latest\": wfrp4e\n        // },\n        // \"splittermond\": {\n        //   \"latest\": splittermond\n        // },\n        // \"forbidden-lands\": {\n        //   \"latest\": forbiddenLands\n        // },\n        // \"icrpg\": {\n        //   \"latest\": icrpg\n        // },\n        // \"icrpgme\": {\n        //   \"latest\": icrpgme\n        // },\n        // \"swse\": {\n        //   \"latest\": swse\n        // },\n        // \"sw5e\": {\n        //   \"latest\": sw5e,\n        //   \"2.0.3.2.3.8\": sw5e203\n        // },\n        // \"fallout\": {\n        //   \"latest\": fallout\n        // },\n        // \"cyberpunk-red-core\": {\n        //   \"latest\": cyberpunkRedCore\n        // },\n        // \"knave\": {\n        //   \"latest\": knave\n        // },\n        // \"t2k4e\": {\n        //   \"latest\": t2k4e\n        // },\n        // \"yzecoriolis\": {\n        //   \"latest\": yzecoriolis\n        // },\n        // \"kamigakari\": {\n        //   \"latest\": kamigakari\n        // },\n        // \"wwn\": {\n        //   \"latest\": wwn\n        // },\n        // \"symbaroum\": {\n        //   \"latest\": symbaroum\n        // },\n        // \"cyphersystem\": {\n        //   \"latest\": cyphersystem\n        // },\n        // \"ptu\": {\n        //   \"latest\": ptu\n        // },\n        // \"dcc\": {\n        //   \"latest\": dcc\n        // },\n        a5e: {\n            latest: a5e,\n        },\n        // \"dark-heresy\": {\n        //   \"latest\": darkHeresy2e\n        // },\n        // \"naheulbeuk\": {\n        //   \"latest\": naheulbeuk\n        // },\n        // \"pirateborg\": {\n        //   \"latest\": pirateborg\n        // },\n        // \"starwarsffg\": {\n        //   \"latest\": starwarsffg\n        // }\n        // ↑ ADD SYSTEMS HERE ↑\n    },\n\n    DEFAULT_SETTINGS:<any>{\n        ACTOR_CURRENCY_ATTRIBUTE: \"\",\n    },\n\n    get HAS_SYSTEM_SUPPORT() {\n        return !!this.SUPPORTED_SYSTEMS?.[game.system.id.toLowerCase()];\n    },\n\n    _currentSystem:<any> false,\n\n    get DATA() {\n        if (this._currentSystem) return this._currentSystem;\n\n        const system = this.SUPPORTED_SYSTEMS?.[game.system.id.toLowerCase()];\n        if (!system) return this.DEFAULT_SETTINGS;\n\n        // @ts-ignore\n        if (system[game.system.version]) {\n            // @ts-ignore\n            this._currentSystem = foundry.utils.mergeObject(this.DEFAULT_SETTINGS, system[game.system.version]);\n            return this._currentSystem;\n        }\n\n        const versions = Object.keys(system);\n        if (versions.length === 1) {\n            this._currentSystem = foundry.utils.mergeObject(this.DEFAULT_SETTINGS, system[versions[0]]);\n            return this._currentSystem;\n        }\n\n        versions.sort((a, b) => {\n            return a === \"latest\" || b === \"latest\" ? -Infinity : isNewerVersion(b, a) ? -1 : 1;\n        });\n        const version:any = versions.find((version) => {\n            // @ts-ignore\n            return version === \"latest\" || !isNewerVersion(game.system.version, version);\n        });\n\n        this._currentSystem = foundry.utils.mergeObject(this.DEFAULT_SETTINGS, system[version]);\n\n        return this._currentSystem;\n    },\n\n    addSystem(data:any) {\n        this.SUPPORTED_SYSTEMS[game.system.id.toLowerCase()] = { latest: data };\n    },\n}; ","import { id } from \"../module.json\";\nimport { SYSTEMS } from \"./systems\";\n\nexport const CONSTANTS:any = {\n    MODULE_ID: id\n}\n\n\nexport const moduleId = id;\n\n// Store the rolls made during this session\nexport const recentRolls: any[] = [];\nexport const MAX_ROLLS_STORED = 20; // Store up to 20 recent rolls\n\nexport const SETTINGS = {\n    // Client settings\n    ACTOR_CURRENCY_ATTRIBUTE: \"actorCurrencyAttribute\",\n    WS_RELAY_URL: \"wsRelayUrl\",\n    API_KEY: \"apiKey\",\n    CUSTOM_NAME: \"customName\",\n    LOG_LEVEL: \"logLevel\",\n    PING_INTERVAL: \"pingInterval\",\n    RECONNECT_MAX_ATTEMPTS: \"reconnectMaxAttempts\",\n    RECONNECT_BASE_DELAY: \"reconnectBaseDelay\",\n\n    // Hidden settings\n    SYSTEM_FOUND: \"systemFound\",\n    SYSTEM_NOT_FOUND_WARNING_SHOWN: \"systemNotFoundWarningShown\",\n    SYSTEM_VERSION: \"systemVersion\",\n\n    GET_DEFAULT() {\n        return foundry.utils.deepClone(SETTINGS.DEFAULTS());\n    },\n\n    GET_SYSTEM_DEFAULTS() {\n        return Object.fromEntries(\n            Object.entries(SETTINGS.GET_DEFAULT()).filter((entry) => {\n                return entry[1].system;\n            }),\n        );\n    },\n\n    DEFAULTS: () => ({\n\n        // SYSTEM SETTINGS CLIENT\n\n        [SETTINGS.ACTOR_CURRENCY_ATTRIBUTE]: {\n            name: `Actor Currency attribute`,\n            hint: `Reference path to the actor currency attribute`,\n            scope: \"world\",\n            config: false,\n            system: true,\n            default: SYSTEMS.DATA.ACTOR_CURRENCY_ATTRIBUTE,\n            type: String,\n        },\n\n        // SYSTEM SETTINGS HIDDEN\n\n        [SETTINGS.SYSTEM_VERSION]: {\n            scope: \"world\",\n            config: false,\n            default: \"0.0.0\",\n            type: String,\n        },\n\n        [SETTINGS.SYSTEM_FOUND]: {\n            scope: \"world\",\n            config: false,\n            default: false,\n            type: Boolean,\n        },\n\n        [SETTINGS.SYSTEM_NOT_FOUND_WARNING_SHOWN]: {\n            scope: \"world\",\n            config: false,\n            default: false,\n            type: Boolean,\n        },\n\n        // WORLD SETTINGS\n\n        [SETTINGS.WS_RELAY_URL]: {\n            name: \"WebSocket Relay URL\",\n            hint: \"URL for the WebSocket relay server\",\n            scope: \"world\",\n            config: true,\n            type: String,\n            default: \"wss://foundryvtt-rest-api-relay.fly.dev\",\n            requiresReload: true\n        },\n\n        [SETTINGS.API_KEY]: {\n            name: \"API Key\",\n            hint: \"API Key for authentication with the relay server\",\n            scope: \"world\",\n            config: true,\n            type: String,\n            default: game.world.id,\n            requiresReload: true\n        },\n\n        [SETTINGS.CUSTOM_NAME]: {\n            name: \"Custom Client Name\",\n            hint: \"A custom name to identify this client (optional)\",\n            scope: \"world\",\n            config: true,\n            type: String,\n            default: \"\",\n            requiresReload: true\n        },\n\n        [SETTINGS.LOG_LEVEL]: {\n            name: \"Log Level\",\n            hint: \"Set the level of detail for module logging\",\n            scope: \"world\",\n            config: true,\n            type: Number,\n            choices: {\n                0: \"debug\",\n                1: \"info\",\n                2: \"warn\",\n                3: \"error\"\n            },\n            default: 2\n        },\n\n        [SETTINGS.PING_INTERVAL]: {\n            name: \"Ping Interval (seconds)\",\n            hint: \"How often (in seconds) the module sends a ping to the relay server to keep the connection alive.\",\n            scope: \"world\",\n            config: true,\n            type: Number,\n            default: 30,\n            range: {\n              min: 5,\n              max: 600,\n              step: 1\n            },\n            requiresReload: true\n        },\n\n        [SETTINGS.RECONNECT_MAX_ATTEMPTS]: {\n            name: \"Max Reconnect Attempts\",\n            hint: \"Maximum number of times the module will try to reconnect after losing connection.\",\n            scope: \"world\",\n            config: true,\n            type: Number,\n            default: 20,\n            requiresReload: true\n        },\n\n        [SETTINGS.RECONNECT_BASE_DELAY]: {\n            name: \"Reconnect Base Delay (ms)\",\n            hint: \"Initial delay (in milliseconds) before the first reconnect attempt. Subsequent attempts use exponential backoff.\",\n            scope: \"world\",\n            config: true,\n            type: Number,\n            default: 1000,\n            requiresReload: true\n        }\n    })\n};","// src/ts/utils/logger.ts\nimport { moduleId } from \"../constants\";\n\n/**\n * Utility for module logging with debug mode support\n */\nexport class ModuleLogger {\n  /**\n   * Check if debug mode is enabled\n   */\n  static debugLevel(): number {\n    return (game as Game).settings.get(moduleId, \"logLevel\") as number;\n  }\n\n  /**\n   * Log a debug message (only when debug mode is enabled)\n   */\n  static debug(message: string, ...args: any[]): string {\n    if (this.debugLevel() < 1) {\n      console.log(`${moduleId} | ${message}`, ...args);\n    }\n    return message;\n  }\n\n  /**\n   * Log info message (always shown)\n   */\n  static info(message: string, ...args: any[]): string {\n    if (this.debugLevel() < 2) {\n        console.log(`${moduleId} | ${message}`, ...args);\n    }\n    return message;\n  }\n\n  /**\n   * Log warning message (always shown)\n   */\n  static warn(message: string, ...args: any[]): string {\n    if (this.debugLevel() < 3) {\n      console.warn(`${moduleId} | ${message}`, ...args);\n    }\n    return message;\n  }\n\n  /**\n   * Log error message (always shown)\n   */\n  static error(message: string, ...args: any[]): string {\n    if (this.debugLevel() < 4) {\n        console.error(`${moduleId} | ${message}`, ...args);\n    }\n    return message;\n  }\n}","import { WebSocketManager } from \"./network/webSocketManager\";\n\n// WebSocket close codes\nexport enum WSCloseCodes {\n  Normal = 1000,\n  NoClientId = 4001,\n  NoAuth = 4002,\n  NoConnectedGuild = 4003,\n  InternalError = 4000,\n  DuplicateConnection = 4004,\n  ServerShutdown = 4005,\n}\n\n// Module-specific interfaces\nexport interface FoundryRestApi extends Game.ModuleData<any> {\n  socketManager: WebSocketManager | null;\n  api: FoundryRestApiAPI;\n}\n\nexport interface FoundryRestApiAPI {\n  getWebSocketManager: () => WebSocketManager | null;\n  search: (query: string, filter?: string) => Promise<any[]>;\n  getByUuid: (uuid: string) => Promise<any>;\n}\n\nexport interface WebSocketMessage {\n  type: string;\n  data: any;\n  sender?: string;\n  timestamp?: number;\n}\n\nexport interface ChatMessage {\n  content: string;\n  sender: string;\n  timestamp: number;\n}\n\nexport interface BackupFolder {\n  path: string;\n  name: string;\n}\n\n// Server route types\nexport declare namespace ServerRoutes {\n  export interface BackupResponse {\n    backups: string[];\n  }\n  \n  export interface APIDocsResponse {\n    message: string;\n    endpoints: {\n      path: string;\n      description: string;\n    }[];\n  }\n}\n\n// Make sure TypeScript sees this file as a module\nexport {};\n","import { WSCloseCodes } from \"../types\";\nimport { ModuleLogger } from \"../utils/logger\";\nimport { moduleId, SETTINGS } from \"../constants\"; // Corrected import path\nimport { HandlerContext } from \"./routers/baseRouter\"\n\ntype MessageHandler = (data: any, context: HandlerContext) => void;\n\nexport class WebSocketManager {\n  private url: string;\n  private token: string;\n  private socket: WebSocket | null = null;\n  private messageHandlers: Map<string, MessageHandler> = new Map();\n  private reconnectTimer: number | null = null;\n  private reconnectAttempts: number = 0;\n  private clientId: string;\n  private pingInterval: number | null = null;\n  private isConnecting: boolean = false;\n  private isPrimaryGM: boolean = false;\n  \n  // Singleton instance\n  private static instance: WebSocketManager | null = null;\n\n  constructor(url: string, token: string) {\n    this.url = url;\n    this.token = token;\n    this.clientId = `foundry-${game.user?.id || Math.random().toString(36).substring(2, 15)}`;\n    \n    // Determine if this is the primary GM (lowest user ID among full GMs with role 4)\n    this.isPrimaryGM = this.checkIfPrimaryGM();\n    \n    ModuleLogger.info(`Created WebSocketManager with clientId: ${this.clientId}, isPrimaryGM: ${this.isPrimaryGM}`);\n    \n    // Listen for user join/leave events to potentially take over as primary\n    if (game.user?.isGM && game.user?.role === 4) {\n      // When another user connects or disconnects, check if we need to become primary\n      Hooks.on(\"userConnected\", this.reevaluatePrimaryGM.bind(this));\n      Hooks.on(\"userDisconnected\", this.reevaluatePrimaryGM.bind(this));\n    }\n  }\n  \n  /**\n   * Factory method that ensures only one instance is created and only for GM users\n   * @param url The WebSocket server URL\n   * @param token The authorization token\n   * @returns WebSocketManager instance or null if not GM\n   */\n  public static getInstance(url: string, token: string): WebSocketManager | null {\n    // Only create an instance if the user is a full GM (role 4), not Assistant GM\n    if (!game.user?.isGM || game.user?.role !== 4) {\n      ModuleLogger.info(`WebSocketManager not created - user is not a full GM`);\n      return null;\n    }\n    \n    // Only create the instance once\n    if (!WebSocketManager.instance) {\n      ModuleLogger.info(`Creating new WebSocketManager instance`);\n      WebSocketManager.instance = new WebSocketManager(url, token);\n    }\n    \n    return WebSocketManager.instance;\n  }\n\n  /**\n   * Determines if this GM has the lowest user ID among all active GMs\n   */\n  private checkIfPrimaryGM(): boolean {\n    // Make sure current user is a full GM (role 4), not an Assistant GM\n    if (!game.user?.isGM || game.user?.role !== 4) return false;\n    \n    const currentUserId = game.user?.id;\n    // Only consider active users with role 4 (full GM), not Assistant GMs (role 3)\n    const activeGMs = game.users?.filter(u => u.role === 4 && u.active) || [];\n    \n    if (activeGMs.length === 0) return false;\n    \n    // Sort by user ID (alphanumeric)\n    const sortedGMs = [...activeGMs].sort((a, b) => (a.id || '').localeCompare(b.id || ''));\n    \n    // Check if current user has the lowest ID\n    const isPrimary = sortedGMs[0]?.id === currentUserId;\n    \n    ModuleLogger.info(`Primary GM check - Current user: ${currentUserId}, Primary GM: ${sortedGMs[0]?.id}, isPrimary: ${isPrimary}`);\n    \n    return isPrimary;\n  }\n  \n  /**\n   * Re-evaluate if this GM should be the primary when users connect/disconnect\n   */\n  private reevaluatePrimaryGM(): void {\n    const wasPrimary = this.isPrimaryGM;\n    this.isPrimaryGM = this.checkIfPrimaryGM();\n    \n    // If status changed, log it\n    if (wasPrimary !== this.isPrimaryGM) {\n      ModuleLogger.info(`Primary GM status changed: ${wasPrimary} -> ${this.isPrimaryGM}`);\n      \n      // If we just became primary, connect\n      if (this.isPrimaryGM && !this.isConnected()) {\n        ModuleLogger.info(`Taking over as primary GM, connecting WebSocket`);\n        this.connect();\n      }\n      \n      // If we're no longer primary, disconnect\n      if (!this.isPrimaryGM && this.isConnected()) {\n        ModuleLogger.info(`No longer primary GM, disconnecting WebSocket`);\n        this.disconnect();\n      }\n    }\n  }\n\n  connect(): void {\n    // Double-check that user is still a full GM (role 4) and is the primary GM before connecting\n    if (!game.user?.isGM || game.user?.role !== 4) {\n      ModuleLogger.info(`WebSocket connection aborted - user is not a full GM`);\n      return;\n    }\n    \n    if (!this.isPrimaryGM) {\n      ModuleLogger.info(`WebSocket connection aborted - user is not the primary GM`);\n      return;\n    }\n    \n    if (this.isConnecting) {\n      ModuleLogger.info(`Already attempting to connect`);\n      return;\n    }\n\n    if (this.socket && (this.socket.readyState === WebSocket.CONNECTING || this.socket.readyState === WebSocket.OPEN)) {\n      ModuleLogger.info(`WebSocket already connected or connecting`);\n      return;\n    }\n\n    this.isConnecting = true;\n\n    try {\n      // Build the WebSocket URL with query parameters\n      const wsUrl = new URL(this.url);\n      wsUrl.searchParams.set('id', this.clientId);\n      wsUrl.searchParams.set('token', this.token);\n      if (game.world) {\n        wsUrl.searchParams.set('worldId', game.world.id);\n        wsUrl.searchParams.set('worldTitle', (game.world as any).title);\n      }\n      \n      // Add version and system information\n      wsUrl.searchParams.set('foundryVersion', game.version);\n      wsUrl.searchParams.set('systemId', game.system.id);\n      wsUrl.searchParams.set('systemTitle', (game.system as any).title || game.system.id);\n      wsUrl.searchParams.set('systemVersion', (game.system as any).version || 'unknown');\n      \n      // Add custom name if set\n      const customName = game.settings.get(moduleId, \"customName\") as string;\n      if (customName) {\n        wsUrl.searchParams.set('customName', customName);\n      }\n      \n      ModuleLogger.info(`Connecting to WebSocket at ${wsUrl.toString()}`);\n      \n      // Create WebSocket and set up event handlers\n      this.socket = new WebSocket(wsUrl.toString());\n\n      // Add timeout for connection attempt\n      const connectionTimeout = window.setTimeout(() => {\n        if (this.socket && this.socket.readyState === WebSocket.CONNECTING) {\n          ModuleLogger.error(`Connection timed out`);\n          this.socket.close();\n          this.socket = null;\n          this.isConnecting = false;\n          this.scheduleReconnect();\n        }\n      }, 5000); // 5 second timeout\n\n      this.socket.addEventListener('open', (event) => {\n        window.clearTimeout(connectionTimeout);\n        this.onOpen(event);\n      });\n      \n      this.socket.addEventListener('close', (event) => {\n        window.clearTimeout(connectionTimeout);\n        this.onClose(event);\n      });\n      \n      this.socket.addEventListener('error', (event) => {\n        window.clearTimeout(connectionTimeout);\n        this.onError(event);\n      });\n      \n      this.socket.addEventListener('message', this.onMessage.bind(this));\n    } catch (error) {\n      ModuleLogger.error(`Error creating WebSocket:`, error);\n      this.isConnecting = false;\n      this.scheduleReconnect();\n    }\n  }\n\n  disconnect(): void {\n    if (this.socket) {\n      ModuleLogger.info(`Disconnecting WebSocket`);\n      this.socket.close(WSCloseCodes.Normal, \"Disconnecting\");\n      this.socket = null;\n    }\n    \n    if (this.reconnectTimer !== null) {\n      window.clearTimeout(this.reconnectTimer);\n      this.reconnectTimer = null;\n    }\n    \n    if (this.pingInterval !== null) {\n      window.clearInterval(this.pingInterval);\n      this.pingInterval = null;\n    }\n    \n    this.reconnectAttempts = 0;\n    this.isConnecting = false;\n  }\n\n  isConnected(): boolean {\n    return this.socket !== null && this.socket.readyState === WebSocket.OPEN;\n  }\n\n  getClientId(): string {\n    return this.clientId;\n  }\n\n  send(data: any): boolean {\n    ModuleLogger.info(`Send called, readyState: ${this.socket?.readyState}`);\n    \n    // Ensure we're connected\n    if (this.socket && this.socket.readyState === WebSocket.OPEN) {\n      try {\n        ModuleLogger.info(`Sending message:`, data);\n        this.socket.send(JSON.stringify(data));\n        return true;\n      } catch (error) {\n        ModuleLogger.error(`Error sending message:`, error);\n        return false;\n      }\n    } else {\n      ModuleLogger.warn(`WebSocket not ready, state: ${this.socket?.readyState}`);\n      return false;\n    }\n  }\n\n  onMessageType(type: string, handler: MessageHandler): void {\n    this.messageHandlers.set(type, handler);\n  }\n\n  private onOpen(_event: Event): void {\n    ModuleLogger.info(`WebSocket connected`);\n    this.isConnecting = false;\n    this.reconnectAttempts = 0;\n    \n    // Send an initial ping\n    this.send({ type: \"ping\" });\n    \n    // Start ping interval using the setting value\n    const pingIntervalSeconds = game.settings.get(moduleId, SETTINGS.PING_INTERVAL) as number;\n    const pingIntervalMs = pingIntervalSeconds * 1000;\n    ModuleLogger.info(`Starting application ping interval: ${pingIntervalSeconds} seconds`);\n    \n    // Clear any existing interval first\n    if (this.pingInterval !== null) {\n      window.clearInterval(this.pingInterval);\n    }\n    \n    this.pingInterval = window.setInterval(() => {\n      if (this.isConnected()) {\n        this.send({ type: \"ping\" });\n      }\n    }, pingIntervalMs);\n  }\n\n  private onClose(event: CloseEvent): void {\n    ModuleLogger.info(`WebSocket disconnected: ${event.code} - ${event.reason}`);\n    this.socket = null;\n    this.isConnecting = false;\n    \n    // Clear ping interval\n    if (this.pingInterval !== null) {\n      window.clearInterval(this.pingInterval);\n      this.pingInterval = null;\n    }\n    \n    // Don't reconnect if this was a normal closure or if not primary GM\n    if (event.code !== WSCloseCodes.Normal && this.isPrimaryGM) {\n      this.scheduleReconnect();\n    }\n  }\n\n  private onError(event: Event): void {\n    ModuleLogger.error(`WebSocket error:`, event);\n    this.isConnecting = false;\n  }\n\n  private async onMessage(event: MessageEvent): Promise<void> {\n    try {\n      const data = JSON.parse(event.data);\n      ModuleLogger.info(`Received message:`, data);\n      \n      if (data.type && this.messageHandlers.has(data.type)) {\n        ModuleLogger.info(`Handling message of type: ${data.type}`);\n          this.messageHandlers.get(data.type)!(data, {socketManager: this} as HandlerContext);\n      } else if (data.type) {\n        ModuleLogger.warn(`No handler for message type: ${data.type}`);\n      }\n    } catch (error) {\n      ModuleLogger.error(`Error processing message:`, error);\n    }\n  }\n\n  private scheduleReconnect(): void {\n    if (this.reconnectTimer !== null) {\n      return; // Already scheduled\n    }\n    \n    // Read settings for reconnection parameters\n    const maxAttempts = game.settings.get(moduleId, SETTINGS.RECONNECT_MAX_ATTEMPTS) as number;\n    const baseDelay = game.settings.get(moduleId, SETTINGS.RECONNECT_BASE_DELAY) as number;\n    \n    this.reconnectAttempts++;\n    \n    if (this.reconnectAttempts > maxAttempts) {\n      ModuleLogger.error(`Maximum reconnection attempts (${maxAttempts}) reached`);\n      this.reconnectAttempts = 0; // Reset for future disconnections\n      return;\n    }\n    \n    // Calculate delay with exponential backoff (max 30 seconds)\n    const delay = Math.min(30000, baseDelay * Math.pow(2, this.reconnectAttempts - 1));\n    ModuleLogger.info(`Scheduling reconnect in ${delay}ms (attempt ${this.reconnectAttempts}/${maxAttempts})`);\n    \n    this.reconnectTimer = window.setTimeout(() => {\n      this.reconnectTimer = null;\n      // Only attempt reconnect if still the primary GM\n      if (this.isPrimaryGM) {\n         ModuleLogger.info(`Attempting reconnect...`);\n         this.connect();\n      } else {\n         ModuleLogger.info(`Reconnect attempt aborted - no longer primary GM.`);\n         this.reconnectAttempts = 0; // Reset attempts if not primary\n      }\n    }, delay);\n  }\n}","import { WebSocketManager } from \"../webSocketManager\";\n\n\nexport interface HandlerContext {\n    socketManager: WebSocketManager\n}\n\n\nexport interface RouteI {\n    actionType: string\n    handler: (data: any, context: HandlerContext | undefined) => void\n}\n\ninterface RouterI {\n    title: string,\n    routes: RouteI[]\n}\n\nexport class Router implements RouterI {\n    title: string\n    routes: RouteI[]\n\n    constructor(title: string, routes: RouteI[] = []) {\n        this.title = title,\n            this.routes = routes\n    }\n\n    addRoute(route: RouteI) {\n        this.routes.push(\n            route\n        )\n    }\n\n    reflect(socketManager: WebSocketManager) {\n        this.routes.forEach(\n            (route: RouteI) => socketManager.onMessageType(route.actionType, route.handler)\n        )\n    }\n}\n","import {Router, HandlerContext} from \"./baseRouter\"\nimport { ModuleLogger } from \"../../utils/logger\"\n\nexport const router = new Router(\n    \"pingRouter\"\n)\n\nrouter.addRoute(\n    {\n        actionType: \"ping\",\n        handler: (context: HandlerContext) => {\n            ModuleLogger.info(`Received ping, sending pong`);\n            context.socketManager.send({ type: \"pong\" });\n        }\n    }\n)\n\nrouter.addRoute(\n    {\n        actionType: \"pong\",\n        handler: () => {\n            ModuleLogger.info(`Received pong`);\n        }\n    }\n)\n","/**\n * Utility functions for data serialization\n */\nimport { ModuleLogger } from \"./logger\";\n\n// Interface for collection-like objects in Foundry VTT\ninterface FoundryCollection<T> {\n    size: number;\n    contents: T[];\n    entries(): IterableIterator<[string, T]>;\n\n    // Other collection methods could be added here if needed\n}\n\n/**\n * Deep serialize an entity to ensure all properties are properly captured\n * @param entity The entity to serialize\n * @returns A fully serialized copy of the entity\n */\nexport function deepSerializeEntity(entity: any): any {\n    if (!entity) return null;\n    \n    try {\n        // Start with a standard serialization\n        let serialized = entity.toObject ? entity.toObject(true) : JSON.parse(JSON.stringify(entity));\n\n        // Some systems have getter properties that aren't properly serialized, especially in nested objects\n        // Manually handle key system paths that are commonly used\n        if (entity.system) {\n            // Handle attributes - commonly used in systems like dnd5e\n            if (entity.system.attributes) {\n                for (const [attrKey, attrValue] of Object.entries(entity.system.attributes)) {\n                    // Check if this attribute exists in serialized but is null when it shouldn't be\n                    if (\n                        serialized.system?.attributes?.[attrKey] === null && \n                        attrValue !== null\n                    ) {\n                        if (!serialized.system.attributes) serialized.system.attributes = {};\n                        serialized.system.attributes[attrKey] = JSON.parse(JSON.stringify(attrValue));\n                    }\n                    \n                    // Handle nested attributes (like hp, movement, etc)\n                    if (typeof attrValue === 'object' && attrValue !== null) {\n                        for (const [subKey, subValue] of Object.entries(attrValue)) {\n                            if (\n                                serialized.system?.attributes?.[attrKey]?.[subKey] === null && \n                                subValue !== null\n                            ) {\n                                if (!serialized.system.attributes[attrKey]) serialized.system.attributes[attrKey] = {};\n                                serialized.system.attributes[attrKey][subKey] = JSON.parse(JSON.stringify(subValue));\n                            }\n                        }\n                    }\n                }\n            }\n            \n            // Handle traits, senses, and other commonly used properties\n            ['traits', 'abilities', 'skills', 'resources'].forEach(propKey => {\n                if (entity.system[propKey]) {\n                    for (const [key, value] of Object.entries(entity.system[propKey])) {\n                        if (\n                            serialized.system?.[propKey]?.[key] === null && \n                            value !== null\n                        ) {\n                            if (!serialized.system[propKey]) serialized.system[propKey] = {};\n                            serialized.system[propKey][key] = JSON.parse(JSON.stringify(value));\n                        }\n                        \n                        // Handle nested properties\n                        if (typeof value === 'object' && value !== null) {\n                            for (const [subKey, subValue] of Object.entries(value)) {\n                                if (\n                                    serialized.system?.[propKey]?.[key]?.[subKey] === null && \n                                    subValue !== null\n                                ) {\n                                    if (!serialized.system[propKey][key]) serialized.system[propKey][key] = {};\n                                    serialized.system[propKey][key][subKey] = JSON.parse(JSON.stringify(subValue));\n                                }\n                            }\n                        }\n                    }\n                }\n            });\n        }\n\n        // Special handling for embedded collections \n        if (entity.items && entity.items.size > 0 && Array.isArray(serialized.items)) {\n            // Ensure items are properly serialized\n            try {\n                // Type assertion to help TypeScript understand the collection structure\n                const itemCollection = entity.items as FoundryCollection<any>;\n                \n                // Use contents array if available, as a safer alternative to entries()\n                if (Array.isArray(itemCollection.contents)) {\n                    for (let i = 0; i < itemCollection.contents.length; i++) {\n                        if (i < serialized.items.length) {\n                            // Deep serialize each item\n                            serialized.items[i] = deepSerializeEntity(itemCollection.contents[i]);\n                        }\n                    }\n                } \n                // Fallback to entries() if needed\n                else if (typeof itemCollection.entries === 'function') {\n                    const itemEntries = Array.from(itemCollection.entries());\n                    for (let i = 0; i < itemEntries.length; i++) {\n                        const [_, item] = itemEntries[i];\n                        if (i < serialized.items.length) {\n                            serialized.items[i] = deepSerializeEntity(item);\n                        }\n                    }\n                }\n            } catch (err) {\n                ModuleLogger.warn('Failed to process entity.items collection:', err);\n            }\n        }\n        \n        // Handle effects collection\n        if (entity.effects && entity.effects.size > 0 && Array.isArray(serialized.effects)) {\n            try {\n                // Type assertion to help TypeScript understand the collection structure\n                const effectCollection = entity.effects as FoundryCollection<any>;\n                \n                // Use contents array if available, as a safer alternative to entries()\n                if (Array.isArray(effectCollection.contents)) {\n                    for (let i = 0; i < effectCollection.contents.length; i++) {\n                        if (i < serialized.effects.length) {\n                            // Deep serialize each effect\n                            serialized.effects[i] = deepSerializeEntity(effectCollection.contents[i]);\n                        }\n                    }\n                }\n                // Fallback to entries() if needed\n                else if (typeof effectCollection.entries === 'function') {\n                    const effectEntries = Array.from(effectCollection.entries());\n                    for (let i = 0; i < effectEntries.length; i++) {\n                        const [_, effect] = effectEntries[i];\n                        if (i < serialized.effects.length) {\n                            serialized.effects[i] = deepSerializeEntity(effect);\n                        }\n                    }\n                }\n            } catch (err) {\n                ModuleLogger.warn('Failed to process entity.effects collection:', err);\n            }\n        }\n        \n        return serialized;\n    } catch (error) {\n        ModuleLogger.error(`Error deep serializing entity:`, error);\n        // Fallback to basic serialization in case of errors\n        return entity.toObject ? entity.toObject() : entity;\n    }\n}","import { Router } from \"./baseRouter\";\nimport { ModuleLogger } from \"../../utils/logger\";\nimport { deepSerializeEntity } from \"../../utils/serialization\";\n\nexport const router = new Router(\"entityRouter\");\n\nrouter.addRoute({\n  actionType: \"entity\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received entity request:`, data);\n\n    try {\n      let entity;\n      let entityData = [];\n      let entityUUID = data.uuid;\n      if (data.selected) {\n        const controlledTokens = canvas?.tokens?.controlled;\n        if (controlledTokens) {\n          for (let token of controlledTokens) {\n            if (data.actor) {\n              entity = token.actor;\n            } else {\n              entity = token.document;\n            }\n            if (entity) {\n              entityUUID = entity.uuid;\n              // Use custom deep serialization\n              entityData.push(deepSerializeEntity(entity));\n            }\n          }\n        }\n      } else {\n        entity = await fromUuid(data.uuid);\n        // Use custom deep serialization\n        entityData = entity ? deepSerializeEntity(entity) : null;\n      }\n\n      if (!entityData) {\n        ModuleLogger.error(`Entity not found: ${data.uuid}`);\n        socketManager?.send({\n          type: \"entity-result\",\n          requestId: data.requestId,\n          uuid: data.uuid,\n          error: \"Entity not found\",\n          data: null,\n        });\n        return;\n      }\n\n      ModuleLogger.info(`Sending entity data for: ${data.uuid}`, entityData);\n\n      socketManager?.send({\n        type: \"entity-result\",\n        requestId: data.requestId,\n        uuid: entityUUID,\n        data: entityData,\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error getting entity:`, error);\n      socketManager?.send({\n        type: \"entity-result\",\n        requestId: data.requestId,\n        uuid: data.uuid,\n        error: (error as Error).message,\n        data: null,\n      });\n    }\n  },\n});\n\n// Handle entity creation\nrouter.addRoute({\n  actionType: \"create\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received create entity request for type: ${data.entityType}`);\n\n    try {\n      const DocumentClass = getDocumentClass(data.entityType);\n      if (!DocumentClass) {\n        throw new Error(`Invalid entity type: ${data.entityType}`);\n      }\n\n      const createData = {\n        ...data.data,\n        folder: data.folder || null\n      };\n\n      const entity = await DocumentClass.create(createData);\n\n      if (!entity) {\n        throw new Error(\"Failed to create entity\");\n      }\n\n      socketManager?.send({\n        type: \"create-result\",\n        requestId: data.requestId,\n        uuid: entity.uuid,\n        entity: entity.toObject()\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error creating entity:`, error);\n      socketManager?.send({\n        type: \"create-result\",\n        requestId: data.requestId,\n        error: (error as Error).message,\n        message: \"Failed to create entity\"\n      });\n    }\n  }\n});\n\n// Handle decrease attribute request\nrouter.addRoute({\n  actionType: \"decrease\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received decrease attribute request for attribute: ${data.attribute}, amount: ${data.amount}`);\n\n    try {\n      if (!data.uuid && !data.selected) {\n        throw new Error(\"UUID or selected is required\");\n      }\n      if (!data.attribute) throw new Error(\"Attribute path is required\");\n      if (typeof data.amount !== 'number') throw new Error(\"Amount must be a number\");\n\n      const entities = [];\n      if (data.selected) {\n        const controlledTokens = canvas?.tokens?.controlled || [];\n        for (const token of controlledTokens) {\n          if (token.actor) {\n            entities.push(token.actor);\n          }\n        }\n      } else if (data.uuid) {\n        const entity = await fromUuid(data.uuid);\n        if (entity) {\n          entities.push(entity);\n        }\n      }\n\n      if (entities.length === 0) {\n        throw new Error(\"No entities found to modify\");\n      }\n\n      const results = [];\n      for (const entity of entities) {\n        const currentValue = getProperty(entity, data.attribute);\n        if (typeof currentValue !== 'number') {\n          throw new Error(`Attribute ${data.attribute} is not a number, found: ${typeof currentValue}`);\n        }\n\n        const newValue = currentValue - data.amount;\n        const updateData: { [key: string]: number } = {};\n        updateData[data.attribute] = newValue;\n\n        await entity.update(updateData);\n\n        results.push({\n          uuid: (entity as any).uuid,\n          attribute: data.attribute,\n          oldValue: currentValue,\n          newValue: newValue\n        });\n      }\n\n      socketManager?.send({\n        type: \"decrease-result\",\n        requestId: data.requestId,\n        results,\n        success: true\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error decreasing attribute:`, error);\n      socketManager?.send({\n        type: \"decrease-result\",\n        requestId: data.requestId,\n        success: false,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\n// Handle increase attribute request\nrouter.addRoute({\n  actionType: \"increase\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received increase attribute request for attribute: ${data.attribute}, amount: ${data.amount}`);\n\n    try {\n      if (!data.uuid && !data.selected) {\n        throw new Error(\"UUID or selected is required\");\n      }\n      if (!data.attribute) throw new Error(\"Attribute path is required\");\n      if (typeof data.amount !== 'number') throw new Error(\"Amount must be a number\");\n\n      const entities = [];\n      if (data.selected) {\n        const controlledTokens = canvas?.tokens?.controlled || [];\n        for (const token of controlledTokens) {\n          if (token.actor) {\n            entities.push(token.actor);\n          }\n        }\n      } else if (data.uuid) {\n        const entity = await fromUuid(data.uuid);\n        if (entity) {\n          entities.push(entity);\n        }\n      }\n\n      if (entities.length === 0) {\n        throw new Error(\"No entities found to modify\");\n      }\n\n      const results = [];\n      for (const entity of entities) {\n        const currentValue = getProperty(entity, data.attribute);\n        if (typeof currentValue !== 'number') {\n          throw new Error(`Attribute ${data.attribute} is not a number, found: ${typeof currentValue}`);\n        }\n\n        const newValue = currentValue + data.amount;\n        const updateData: { [key: string]: unknown } = {};\n        updateData[data.attribute] = newValue;\n\n        await entity.update(updateData);\n\n        results.push({\n          uuid: (entity as any).uuid,\n          attribute: data.attribute,\n          oldValue: currentValue,\n          newValue: newValue\n        });\n      }\n\n      socketManager?.send({\n        type: \"increase-result\",\n        requestId: data.requestId,\n        results,\n        success: true\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error increasing attribute:`, error);\n      socketManager?.send({\n        type: \"increase-result\",\n        requestId: data.requestId,\n        success: false,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\n// Handle entity update\nrouter.addRoute({\n  actionType: \"update\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received update entity request for UUID: ${data.uuid}`);\n\n    try {\n      let entities = [];\n      if (data.uuid) {\n        entities.push(await fromUuid(data.uuid));\n      } else if (data.selected) {\n        const controlledTokens = canvas?.tokens?.controlled;\n        if (controlledTokens) {\n          for (let token of controlledTokens) {\n            if (data.actor) {\n              entities.push(token.actor);\n            } else {\n              entities.push(token.document);\n            }\n          }\n        }\n      }\n\n      if (entities.length === 0) {\n        throw new Error(`Entity not found: ${data.uuid}`);\n      }\n\n      for (let entity of entities) {\n        await entity?.update(data.data);\n      }\n\n      let updatedEntities = [];\n      for (let entity of entities) {\n        updatedEntities.push(await fromUuid((entity as any).uuid));\n      }\n\n      socketManager?.send({\n        type: \"update-result\",\n        requestId: data.requestId,\n        uuid: data.uuid,\n        entity: updatedEntities.map(e => e?.toObject())\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error updating entity:`, error);\n      socketManager?.send({\n        type: \"update-result\",\n        requestId: data.requestId,\n        uuid: data.uuid,\n        error: (error as Error).message,\n        message: \"Failed to update entity\"\n      });\n    }\n  }\n});\n\n// Handle entity deletion\nrouter.addRoute({\n  actionType: \"delete\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received delete entity request for UUID: ${data.uuid}`);\n\n    try {\n      let entities = [];\n      if (data.uuid) {\n        entities.push(await fromUuid(data.uuid));\n      } else if (data.selected) {\n        const controlledTokens = canvas?.tokens?.controlled;\n        if (controlledTokens) {\n          for (let token of controlledTokens) {\n            if (data.actor) {\n              entities.push(token.actor);\n            } else {\n              entities.push(token.document);\n            }\n          }\n        }\n      }\n\n      if (!entities || entities.length === 0) {\n        throw new Error(`Entity not found: ${data.uuid}`);\n      }\n\n      for (let entity of entities) {\n        await entity?.delete();\n      }\n\n      socketManager?.send({\n        type: \"delete-result\",\n        requestId: data.requestId,\n        uuid: data.uuid,\n        success: true\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error deleting entity:`, error);\n      socketManager?.send({\n        type: \"delete-result\",\n        requestId: data.requestId,\n        uuid: data.uuid,\n        error: (error as Error).message,\n        message: \"Failed to delete entity\"\n      });\n    }\n  }\n});\n\n// Handle kill request (mark token/actor as defeated)\nrouter.addRoute({\n  actionType: \"kill\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received kill request for UUID: ${data.uuid}`);\n\n    try {\n      const entities = [];\n\n      if (data.uuid) {\n        const entity = await fromUuid(data.uuid);\n        if (entity) {\n          entities.push(entity);\n        } else {\n          throw new Error(`Entity not found: ${data.uuid}`);\n        }\n      } else if (data.selected) {\n        const controlledTokens = canvas?.tokens?.controlled || [];\n        for (const token of controlledTokens) {\n          if (token.document) {\n            entities.push(token.document);\n          }\n        }\n      }\n\n      if (entities.length === 0) {\n        throw new Error(\"No entities found to mark as defeated\");\n      }\n\n      const results = [];\n\n      for (const entity of entities) {\n        let success = false;\n        let message = \"\";\n\n        if (entity.documentName === \"Token\") {\n          const token = entity;\n          const actor = (token as any).actor;\n\n          if (!actor) {\n            throw new Error(\"Token has no associated actor\");\n          }\n\n          const combat = game.combat;\n          if (combat) {\n            const combatant = combat.combatants.find(c => \n              c.token?.id === token.id && c.token?.parent?.id === token.parent?.id\n            );\n            \n            if (combatant) {\n              await combatant.update({ defeated: true });\n              ModuleLogger.info(`Marked token as defeated in combat`);\n            }\n          }\n\n          try {\n            if (hasProperty(actor, \"system.attributes.hp\")) {\n              await actor.update({ \"system.attributes.hp.value\": 0 });\n            } \n            else if (hasProperty(actor, \"system.health\")) {\n              await actor.update({ \"system.health.value\": 0 });\n            }\n            else if (hasProperty(actor, \"system.hp\")) {\n              await actor.update({ \"system.hp.value\": 0 });\n            }\n            else if (hasProperty(actor, \"data.attributes.hp\")) {\n              await actor.update({ \"data.attributes.hp.value\": 0 });\n            }\n            ModuleLogger.info(`Set actor HP to 0`);\n          } catch (err) {\n            ModuleLogger.warn(`Could not set HP to 0: ${err}`);\n          }\n\n          try {\n            const deadEffect = CONFIG.statusEffects?.find(e => \n              e.id === \"dead\" || e.id === \"unconscious\" || e.id === \"defeated\"\n            );\n            \n            if (deadEffect) {\n              await (token as any).toggleActiveEffect(deadEffect);\n              ModuleLogger.info(`Added ${deadEffect.id} status effect to token`);\n            } else {\n              ModuleLogger.warn(`No dead status effect found`);\n            }\n          } catch (err) {\n            ModuleLogger.warn(`Could not apply status effect: ${err}`);\n          }\n\n          success = true;\n          message = \"Token marked as defeated, HP set to 0, and dead effect applied\";\n        } else if (entity.documentName === \"Actor\") {\n          const actor = entity;\n          let tokensUpdated = 0;\n\n          const scenes = game.scenes;\n          if (scenes?.viewed) {\n            const tokens = scenes.viewed.tokens.filter(t => t.actor?.id === actor.id);\n            \n            for (const token of tokens) {\n              try {\n                const deadEffect = CONFIG.statusEffects?.find(e => \n                  e.id === \"dead\" || e.id === \"unconscious\" || e.id === \"defeated\"\n                );\n                \n                if (deadEffect) {\n                  await (token as any).toggleActiveEffect(deadEffect);\n                  tokensUpdated++;\n                }\n              } catch (err) {\n                ModuleLogger.warn(`Could not apply status effect to token: ${err}`);\n              }\n            }\n          }\n\n          const combat = game.combat;\n          if (combat) {\n            const combatants = combat.combatants.filter(c => c.actor?.id === actor.id);\n            \n            if (combatants.length > 0) {\n              await Promise.all(combatants.map(c => c.update({ defeated: true })));\n              ModuleLogger.info(`Marked ${combatants.length} combatants as defeated`);\n            }\n          }\n\n          try {\n            if (hasProperty(actor, \"system.attributes.hp\")) {\n              await actor.update({ \"system.attributes.hp.value\": 0 });\n            } \n            else if (hasProperty(actor, \"system.health\")) {\n              await actor.update({ \"system.health.value\": 0 });\n            }\n            else if (hasProperty(actor, \"system.hp\")) {\n              await actor.update({ \"system.hp.value\": 0 });\n            }\n            else if (hasProperty(actor, \"data.attributes.hp\")) {\n              await actor.update({ \"data.attributes.hp.value\": 0 });\n            }\n            ModuleLogger.info(`Set actor HP to 0`);\n          } catch (err) {\n            ModuleLogger.warn(`Could not set HP to 0: ${err}`);\n          }\n\n          success = true;\n          message = `Actor marked as defeated, HP set to 0, and dead effect applied to ${tokensUpdated} tokens`;\n        } else {\n          throw new Error(`Cannot mark entity type ${entity.documentName} as defeated`);\n        }\n\n        results.push({\n          uuid: (entity as any).uuid,\n          success,\n          message\n        });\n      }\n\n      socketManager?.send({\n        type: \"kill-result\",\n        requestId: data.requestId,\n        results\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error marking entities as defeated:`, error);\n      socketManager?.send({\n        type: \"kill-result\",\n        requestId: data.requestId,\n        success: false,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\n// Handle give item request\nrouter.addRoute({\n  actionType: \"give\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received give item request from ${data.fromUuid} to ${data.toUuid}`);\n\n    try {\n      if (!data.toUuid && !data.selected) {\n        throw new Error(\"Target UUID or selected is required\");\n      }\n      if (!data.itemUuid && !data.itemName) {\n        throw new Error(\"Item UUID or Item Name is required\");\n      }\n\n      let fromEntity: any | null = null;\n      if (data.fromUuid) {\n        fromEntity = await fromUuid(data.fromUuid);\n        if (fromEntity?.documentName !== \"Actor\") {\n          throw new Error(`Source entity must be an Actor, got ${fromEntity?.documentName}`);\n        }\n      }\n\n      if (data.selected) {\n        data.toUuid = canvas?.tokens?.controlled[0]?.actor?.uuid;\n      }\n      const toEntity = await fromUuid(data.toUuid);\n      if (!toEntity) throw new Error(`Target entity not found: ${data.toUuid}`);\n      if (toEntity.documentName !== \"Actor\") {\n        throw new Error(`Target entity must be an Actor, got ${toEntity.documentName}`);\n      }\n\n      let itemEntity: any | null = null;\n      let itemData: any | null = null;\n\n      if (data.itemUuid) {\n        itemEntity = await fromUuid(data.itemUuid);\n        if (itemEntity) {\n          itemData = itemEntity.toObject();\n        }\n      } else if (data.itemName) {\n        if (fromEntity) {\n          itemEntity = fromEntity.items.find((i: any) => i.name.toLowerCase() === data.itemName.toLowerCase());\n          if (itemEntity) {\n            itemData = itemEntity.toObject();\n          }\n        } else {\n          // Global search if no fromUuid\n          if (!window.QuickInsert) {\n            throw new Error(\"QuickInsert is not available for global item search.\");\n          }\n\n          if (!window.QuickInsert.hasIndex) {\n            ModuleLogger.info(`QuickInsert index not ready, forcing index creation`);\n            window.QuickInsert.forceIndex();\n            await new Promise(resolve => setTimeout(resolve, 500)); // Give index time to build\n          }\n          \n          const searchResults = await window.QuickInsert.search(data.itemName, null, 20); // Search all documents\n          const itemSearchResult = searchResults.find(r => r.item?.documentType === \"Item\");\n\n          if (itemSearchResult) {\n            const foundItem = await itemSearchResult.item.get(); // Asynchronously get the full document\n            if (foundItem) {\n              itemData = foundItem.toObject(); // Get the plain data object\n            }\n          }\n        }\n      }\n\n      if (!itemData) throw new Error(`Item not found: ${data.itemUuid || data.itemName}`);\n\n      // This check is only valid if we found an item via UUID or on an actor.\n      if (itemEntity && itemEntity.documentName !== \"Item\") {\n        throw new Error(`Entity must be an Item, got ${itemEntity.documentName}`);\n      }\n\n      // This check is only valid if we found the item on a specific actor.\n      if (itemEntity && fromEntity && itemEntity.parent?.id !== fromEntity.id) {\n        throw new Error(`Item ${data.itemUuid || data.itemName} does not belong to source actor ${data.fromUuid}`);\n      }\n\n      const amountToGive = data.quantity || 1;\n\n      // Check if a stackable item with the same name already exists on the target actor\n      const existingItem = (toEntity as any).items.find((i: any) => i.name === itemData.name);\n      const isStackable = existingItem && hasProperty(existingItem.system, 'quantity');\n      \n      // If a source actor is defined, handle removing/updating the item from them first.\n      if (itemEntity && fromEntity) {\n        const sourceQuantity = getProperty(itemEntity, 'system.quantity');\n        if (typeof sourceQuantity === 'number' && amountToGive < sourceQuantity) {\n            await itemEntity.update({ \"system.quantity\": sourceQuantity - amountToGive });\n        } else {\n            // If giving the whole stack, or it's not a stackable item, delete it.\n            await itemEntity.delete();\n        }\n      }\n\n      let newItemId;\n      let finalQuantity;\n      // Now, add the item to the target actor.\n      if (isStackable) {\n        const newQuantity = existingItem.system.quantity + amountToGive;\n        await existingItem.update({ 'system.quantity': newQuantity });\n        newItemId = existingItem.id;\n        finalQuantity = newQuantity;\n      } else {\n        // If the item doesn't exist on the target or isn't stackable, create a new one.\n        delete itemData._id;\n        if (hasProperty(itemData, 'system.quantity')) {\n            itemData.system.quantity = amountToGive;\n        } else if (itemData.system) { // Handle items that might not have quantity by default\n            itemData.system.quantity = amountToGive;\n        }\n        finalQuantity = amountToGive;\n\n        const newItems = await (toEntity as any).createEmbeddedDocuments(\"Item\", [itemData]);\n        newItemId = newItems[0].id;\n      }\n\n      socketManager?.send({\n        type: \"give-result\",\n        requestId: data.requestId,\n        fromUuid: data.fromUuid,\n        selected: data.selected,\n        toUuid: data.toUuid,\n        quantity: finalQuantity,\n        itemUuid: data.itemUuid,\n        newItemId: newItemId,\n        success: true\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error giving item:`, error);\n      socketManager?.send({\n        type: \"give-result\",\n        requestId: data.requestId,\n        selected: data.selected,\n        fromUuid: data.fromUuid || \"\",\n        toUuid: data.toUuid || \"\",\n        quantity: data.quantity,\n        itemUuid: data.itemUuid || \"\",\n        success: false,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\n// Handle remove item request\nrouter.addRoute({\n    actionType: \"remove\",\n    handler: async (data, context) => {\n        const socketManager = context?.socketManager;\n        ModuleLogger.info(`Received remove item request from actor: ${data.actorUuid}`);\n\n        try {\n            if (!data.actorUuid && !data.selected) {\n                throw new Error(\"Target actor UUID or selected is required\");\n            }\n            if (!data.itemUuid && !data.itemName) {\n                throw new Error(\"Item UUID or Item Name is required\");\n            }\n\n            if (data.selected) {\n                data.actorUuid = canvas?.tokens?.controlled[0]?.actor?.uuid;\n            }\n            const actor = await fromUuid(data.actorUuid);\n            if (!actor) throw new Error(`Target actor not found: ${data.actorUuid}`);\n            if ((actor as any).documentName !== \"Actor\") {\n                throw new Error(`Target entity must be an Actor, got ${(actor as any).documentName}`);\n            }\n\n            let itemEntity: any | null = null;\n            if (data.itemUuid) {\n                itemEntity = await fromUuid(data.itemUuid);\n            } else if (data.itemName) {\n                itemEntity = (actor as any).items.find((i: any) => i.name.toLowerCase() === data.itemName.toLowerCase());\n            }\n\n            if (!itemEntity) throw new Error(`Item not found: ${data.itemUuid || data.itemName}`);\n\n            const amountToRemove = data.quantity || null;\n            const currentQuantity = getProperty(itemEntity, 'system.quantity');\n            let finalQuantity = 0;\n\n            if (amountToRemove && typeof currentQuantity === 'number' && currentQuantity > amountToRemove) {\n                finalQuantity = currentQuantity - amountToRemove;\n                await itemEntity.update({ \"system.quantity\": finalQuantity });\n            } else {\n                await itemEntity.delete();\n            }\n\n            socketManager?.send({\n                type: \"remove-result\",\n                requestId: data.requestId,\n                actorUuid: data.actorUuid,\n                itemUuid: itemEntity.uuid,\n                quantity: finalQuantity,\n                success: true\n            });\n        } catch (error) {\n            ModuleLogger.error(`Error removing item:`, error);\n            socketManager?.send({\n                type: \"remove-result\",\n                requestId: data.requestId,\n                success: false,\n                error: (error as Error).message\n            });\n        }\n    }\n});\n","import { Router } from \"./baseRouter\";\nimport { ModuleLogger } from \"../../utils/logger\";\n\nexport const router = new Router(\"encounterRouter\");\n\nrouter.addRoute({\n  actionType: \"encounters\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received request for encounters`);\n\n    try {\n      const encounters = game.combats?.contents.map(combat => {\n        return {\n          id: combat.id,\n          name: combat.name,\n          round: combat.round,\n          turn: combat.turn,\n          current: combat.id === game.combat?.id,\n          combatants: combat.combatants.contents.map(c => ({\n            id: c.id,\n            name: c.name,\n            tokenUuid: c.token?.uuid,\n            actorUuid: c.actor?.uuid,\n            img: c.img,\n            initiative: c.initiative,\n            hidden: c.hidden,\n            defeated: c.isDefeated\n          }))\n        };\n      }) || [];\n\n      socketManager?.send({\n        type: \"encounters-result\",\n        requestId: data.requestId,\n        encounters\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error getting encounters list:`, error);\n      socketManager?.send({\n        type: \"encounters-result\",\n        requestId: data.requestId,\n        error: (error as Error).message,\n        encounters: []\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"start-encounter\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received request to start encounter with options:`, data);\n\n    try {\n      const combat = await Combat.create({ name: data.name || \"New Encounter\" });\n\n      if (combat) {\n        await combat.startCombat();\n\n        if (data.tokenUuids && data.tokenUuids.length > 0) {\n          const tokensData = [];\n\n          for (const uuid of data.tokenUuids) {\n            try {\n              const token = await fromUuid(uuid);\n              if (token) {\n                tokensData.push({\n                  tokenId: token.id ?? '',\n                  sceneId: token.parent.id\n                });\n              }\n            } catch (err) {\n              ModuleLogger.warn(`Failed to add token ${uuid} to combat:`, err);\n            }\n          }\n\n          if (tokensData.length > 0) {\n            await combat.createEmbeddedDocuments(\"Combatant\", tokensData);\n          }\n        }\n\n        let addedTokenIds = new Set();\n\n        if (data.startWithPlayers) {\n          const currentScene = game.scenes?.viewed;\n\n          if (currentScene) {\n            const playerTokens = currentScene.tokens?.filter(token => !!token.actor && token.actor.hasPlayerOwner) ?? [];\n\n            const tokenData = playerTokens.map(token => {\n              addedTokenIds.add(token.id);\n              return {\n                tokenId: token.id,\n                sceneId: currentScene.id\n              };\n            });\n\n            if (tokenData.length > 0) {\n              await combat.createEmbeddedDocuments(\"Combatant\", tokenData);\n            }\n          }\n        }\n\n        if (data.startWithSelected) {\n          const selectedTokens = canvas?.tokens?.controlled\n            .filter(token => !addedTokenIds.has(token.id))\n            .map(token => ({\n              tokenId: token.id,\n              sceneId: token.scene.id\n            })) ?? [];\n\n          if (selectedTokens.length > 0) {\n            await combat.createEmbeddedDocuments(\"Combatant\", selectedTokens);\n          }\n        }\n\n        if (data.rollNPC) {\n          await combat.rollNPC();\n        }\n\n        if (data.rollAll) {\n          await combat.rollAll();\n        }\n\n        await combat.activate();\n\n        socketManager?.send({\n          type: \"start-encounter-result\",\n          requestId: data.requestId,\n          encounterId: combat.id,\n          encounter: {\n            id: combat.id,\n            name: combat.name,\n            round: combat.round,\n            turn: combat.turn,\n            combatants: combat.combatants.contents.map(c => ({\n              id: c.id,\n              name: c.name,\n              tokenUuid: c.token?.uuid,\n              actorUuid: c.actor?.uuid,\n              img: c.img,\n              initiative: c.initiative,\n              hidden: c.hidden,\n              defeated: c.isDefeated\n            }))\n          }\n        });\n      } else {\n        throw new Error(\"Failed to create encounter\");\n      }\n    } catch (error) {\n      ModuleLogger.error(`Error starting encounter:`, error);\n      socketManager?.send({\n        type: \"start-encounter-result\",\n        requestId: data.requestId,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"next-turn\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received request for next turn in encounter: ${data.encounterId || 'active'}`);\n\n    try {\n      const combat = data.encounterId ? game.combats?.get(data.encounterId) : game.combat;\n\n      if (!combat) {\n        throw new Error(data.encounterId ? `Encounter with ID ${data.encounterId} not found` : \"No active encounter\");\n      }\n\n      await combat.nextTurn();\n\n      socketManager?.send({\n        type: \"next-turn-result\",\n        requestId: data.requestId,\n        encounterId: combat.id,\n        action: \"nextTurn\",\n        currentTurn: combat.turn,\n        currentRound: combat.round,\n        actorTurn: combat.combatant?.actor?.uuid,\n        tokenTurn: combat.combatant?.token?.uuid,\n        encounter: {\n          id: combat.id,\n          name: combat.name,\n          round: combat.round,\n          turn: combat.turn\n        }\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error advancing to next turn:`, error);\n      socketManager?.send({\n        type: \"next-turn-result\",\n        requestId: data.requestId,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"next-round\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received request for next round in encounter: ${data.encounterId || 'active'}`);\n\n    try {\n      const combat = data.encounterId ? game.combats?.get(data.encounterId) : game.combat;\n\n      if (!combat) {\n        throw new Error(data.encounterId ? `Encounter with ID ${data.encounterId} not found` : \"No active encounter\");\n      }\n\n      await combat.nextRound();\n\n      socketManager?.send({\n        type: \"next-round-result\",\n        requestId: data.requestId,\n        encounterId: combat.id,\n        action: \"nextRound\",\n        currentTurn: combat.turn,\n        currentRound: combat.round,\n        actorTurn: combat.combatant?.actor?.uuid,\n        tokenTurn: combat.combatant?.token?.uuid,\n        encounter: {\n          id: combat.id,\n          name: combat.name,\n          round: combat.round,\n          turn: combat.turn\n        }\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error advancing to next round:`, error);\n      socketManager?.send({\n        type: \"next-round-result\",\n        requestId: data.requestId,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"last-turn\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received request for previous turn in encounter: ${data.encounterId || 'active'}`);\n\n    try {\n      const combat = data.encounterId ? game.combats?.get(data.encounterId) : game.combat;\n\n      if (!combat) {\n        throw new Error(data.encounterId ? `Encounter with ID ${data.encounterId} not found` : \"No active encounter\");\n      }\n\n      await combat.previousTurn();\n\n      socketManager?.send({\n        type: \"last-turn-result\",\n        requestId: data.requestId,\n        encounterId: combat.id,\n        action: \"previousTurn\",\n        currentTurn: combat.turn,\n        currentRound: combat.round,\n        actorTurn: combat.combatant?.actor?.uuid,\n        tokenTurn: combat.combatant?.token?.uuid,\n        encounter: {\n          id: combat.id,\n          name: combat.name,\n          round: combat.round,\n          turn: combat.turn\n        }\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error going back to previous turn:`, error);\n      socketManager?.send({\n        type: \"last-turn-result\",\n        requestId: data.requestId,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"last-round\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received request for previous round in encounter: ${data.encounterId || 'active'}`);\n\n    try {\n      const combat = data.encounterId ? game.combats?.get(data.encounterId) : game.combat;\n\n      if (!combat) {\n        throw new Error(data.encounterId ? `Encounter with ID ${data.encounterId} not found` : \"No active encounter\");\n      }\n\n      await combat.previousRound();\n\n      socketManager?.send({\n        type: \"last-round-result\",\n        requestId: data.requestId,\n        encounterId: combat.id,\n        action: \"previousRound\",\n        currentTurn: combat.turn,\n        currentRound: combat.round,\n        actorTurn: combat.combatant?.actor?.uuid,\n        tokenTurn: combat.combatant?.token?.uuid,\n        encounter: {\n          id: combat.id,\n          name: combat.name,\n          round: combat.round,\n          turn: combat.turn\n        }\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error going back to previous round:`, error);\n      socketManager?.send({\n        type: \"encounter-navigation\",\n        requestId: data.requestId,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"end-encounter\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received request to end encounter: ${data.encounterId}`);\n\n    try {\n      let encounterId = data.encounterId;\n      if (!encounterId) {\n        encounterId = game.combat?.id;\n      }\n\n      const combat = game.combats?.get(encounterId);\n\n      if (!combat) {\n        throw new Error(`No encounter not found`);\n      }\n\n      await combat.delete();\n\n      socketManager?.send({\n        type: \"end-encounter-result\",\n        requestId: data.requestId,\n        encounterId: encounterId,\n        message: \"Encounter successfully ended\"\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error ending encounter:`, error);\n      socketManager?.send({\n        type: \"end-encounter-result\",\n        requestId: data.requestId,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"add-to-encounter\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received add-to-encounter request for encounter: ${data.encounterId}`);\n\n    try {\n      const combat = data.encounterId ? game.combats?.get(data.encounterId) : game.combat;\n\n      if (!combat) {\n        throw new Error(data.encounterId ? `Encounter with ID ${data.encounterId} not found` : \"No active encounter\");\n      }\n\n      const addedEntities: string[] = [];\n      const failedEntities = [];\n\n      if (data.uuids && Array.isArray(data.uuids)) {\n        for (const uuid of data.uuids) {\n          try {\n            const entity = await fromUuid(uuid);\n\n            if (!entity) {\n              failedEntities.push({ uuid, reason: \"Entity not found\" });\n              continue;\n            }\n\n            if (entity.documentName === \"Token\") {\n              const token = entity;\n              const combatantData = {\n                tokenId: token.id,\n                sceneId: token.parent?.id\n              };\n\n              await combat.createEmbeddedDocuments(\"Combatant\", [combatantData]);\n              addedEntities.push(uuid);\n            } else if (entity.documentName === \"Actor\") {\n              const scene = game.scenes?.viewed;\n              if (scene) {\n                const tokenForActor = scene.tokens?.find(t => t.actor?.id === entity.id);\n                if (tokenForActor) {\n                  const combatantData = {\n                    tokenId: tokenForActor.id,\n                    sceneId: scene.id\n                  };\n\n                  await combat.createEmbeddedDocuments(\"Combatant\", [combatantData]);\n                  addedEntities.push(uuid);\n                } else {\n                  failedEntities.push({ uuid, reason: \"No token found for this actor in the current scene\" });\n                }\n              } else {\n                failedEntities.push({ uuid, reason: \"No active scene\" });\n              }\n            } else {\n              failedEntities.push({ uuid, reason: \"Entity must be a Token or Actor\" });\n            }\n          } catch (err) {\n            failedEntities.push({ uuid, reason: (err as Error).message });\n          }\n        }\n      }\n\n      if (data.selected === true) {\n        const selectedTokens = canvas?.tokens?.controlled || [];\n\n        for (const token of selectedTokens) {\n          try {\n            if (!combat.combatants.find(c => c.token?.id === token.id && c.combat?.scene?.id === token.scene.id)) {\n              const combatantData = {\n                tokenId: token.id,\n                sceneId: token.scene.id\n              };\n\n              await combat.createEmbeddedDocuments(\"Combatant\", [combatantData]);\n              addedEntities.push(token.document.uuid);\n            }\n          } catch (err) {\n            failedEntities.push({ uuid: token.document.uuid, reason: (err as Error).message });\n          }\n        }\n      }\n\n      if (data.rollInitiative === true && addedEntities.length > 0) {\n        combat.rollAll();\n      }\n\n      socketManager?.send({\n        type: \"add-to-encounter-result\",\n        requestId: data.requestId,\n        encounterId: combat.id,\n        added: addedEntities,\n        failed: failedEntities\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error adding to encounter:`, error);\n      socketManager?.send({\n        type: \"add-to-encounter-result\",\n        requestId: data.requestId,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"remove-from-encounter\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received remove-from-encounter request for encounter: ${data.encounterId}`);\n\n    try {\n      const combat = data.encounterId ? game.combats?.get(data.encounterId) : game.combat;\n\n      if (!combat) {\n        throw new Error(data.encounterId ? `Encounter with ID ${data.encounterId} not found` : \"No active encounter\");\n      }\n\n      const removedEntities = [];\n      const failedEntities = [];\n      const combatantIdsToRemove = [];\n\n      if (data.uuids && Array.isArray(data.uuids)) {\n        for (const uuid of data.uuids) {\n          try {\n            const entity = await fromUuid(uuid);\n\n            if (!entity) {\n              failedEntities.push({ uuid, reason: \"Entity not found\" });\n              continue;\n            }\n\n            let foundCombatant = false;\n\n            if (entity.documentName === \"Token\") {\n              const combatant = combat.combatants.find(c =>\n                c.token?.id === entity.id && c.combat?.scene?.id === entity.parent?.id\n              );\n\n              if (combatant) {\n                combatantIdsToRemove.push(combatant.id);\n                foundCombatant = true;\n              }\n            } else if (entity.documentName === \"Actor\") {\n              const combatants = combat.combatants.filter(c => c.actor?.id === entity.id);\n\n              if (combatants.length > 0) {\n                combatantIdsToRemove.push(...combatants.map(c => c.id));\n                foundCombatant = true;\n              }\n            }\n\n            if (foundCombatant) {\n              removedEntities.push(uuid);\n            } else {\n              failedEntities.push({ uuid, reason: \"No combatant found for this entity\" });\n            }\n          } catch (err) {\n            failedEntities.push({ uuid, reason: (err as Error).message });\n          }\n        }\n      }\n\n      if (data.selected === true) {\n        const selectedTokens = canvas?.tokens?.controlled || [];\n\n        for (const token of selectedTokens) {\n          const combatant = combat.combatants.find(c =>\n            (c as any).tokenId === token.id && (c as any).sceneId === token.scene.id\n          );\n\n          if (combatant) {\n            combatantIdsToRemove.push(combatant.id);\n            removedEntities.push(token.document.uuid);\n          }\n        }\n      }\n\n      if (combatantIdsToRemove.length > 0) {\n        const validIds = combatantIdsToRemove.filter((id): id is string => id !== null);\n        if (validIds.length > 0) {\n          await combat.deleteEmbeddedDocuments(\"Combatant\", validIds);\n        }\n      }\n\n      socketManager?.send({\n        type: \"remove-from-encounter-result\",\n        requestId: data.requestId,\n        encounterId: combat.id,\n        removed: removedEntities,\n        failed: failedEntities\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error removing from encounter:`, error);\n      socketManager?.send({\n        type: \"remove-from-encounter-result\",\n        requestId: data.requestId,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n","import { Router } from \"./baseRouter\";\nimport { ModuleLogger } from \"../../utils/logger\";\nimport { recentRolls } from \"../../constants\";\n\nexport const router = new Router(\"rollRouter\");\n\nrouter.addRoute({\n  actionType: \"rolls\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received request for roll data`);\n\n    socketManager?.send({\n      type: \"rolls-result\",\n      requestId: data.requestId,\n      data: recentRolls.slice(0, data.limit || 20)\n    });\n  }\n});\n\nrouter.addRoute({\n  actionType: \"last-roll\",\n  handler: (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received request for last roll data`);\n\n    socketManager?.send({\n      type: \"last-roll-result\",\n      requestId: data.requestId,\n      data: recentRolls.length > 0 ? recentRolls[0] : null\n    });\n  }\n});\n\nrouter.addRoute({\n  actionType: \"roll\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    try {\n      const { formula, flavor, createChatMessage, speaker, whisper, requestId } = data;\n\n      let rollResult;\n      let speakerData = {};\n      let rollMode = whisper && whisper.length > 0 ? CONST.DICE_ROLL_MODES.PRIVATE : CONST.DICE_ROLL_MODES.PUBLIC;\n\n      // Process speaker if provided\n      if (speaker) {\n        try {\n          const speakerEntity = await fromUuid(speaker);\n\n          if (speakerEntity) {\n            if (speakerEntity instanceof TokenDocument) {\n              speakerData = {\n                token: speakerEntity?.id,\n                actor: speakerEntity?.actor?.id,\n                scene: speakerEntity?.parent?.id,\n                alias: speakerEntity?.name || speakerEntity?.actor?.name\n              };\n            } else if (speakerEntity instanceof Actor) {\n              const activeScene = game.scenes?.active;\n              if (activeScene) {\n                const tokens = activeScene.tokens?.filter(t => t.actor?.id === speakerEntity.id);\n                if (tokens && tokens.length > 0) {\n                  const token = tokens[0];\n                  speakerData = {\n                    token: token.id,\n                    actor: speakerEntity.id,\n                    scene: activeScene.id,\n                    alias: token.name || speakerEntity.name\n                  };\n                } else {\n                  speakerData = {\n                    actor: speakerEntity.id,\n                    alias: speakerEntity.name\n                  };\n                }\n              }\n            }\n          }\n        } catch (err) {\n          ModuleLogger.warn(`Failed to process speaker: ${err}`);\n        }\n      }\n\n      try {\n        const roll = new Roll(formula);\n\n        await roll.evaluate();\n\n        if (createChatMessage) {\n          await roll.toMessage({\n            speaker: speakerData,\n            flavor: flavor || \"\",\n            rollMode,\n            whisper: whisper || []\n          });\n        }\n\n        rollResult = {\n          id: `manual_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`,\n          chatMessageCreated: !!createChatMessage,\n          roll: {\n            formula: formula,\n            total: roll.total,\n            isCritical: roll.terms.some(term => (term as DiceTerm).results?.some(result => result.result === (roll.terms[0] as DiceTerm).faces)),\n            isFumble: roll.terms.some(term => (term as DiceTerm).results?.some(result => result.result === 1)),\n            dice: roll.dice.map(d => ({\n              faces: d.faces,\n              results: d.results.map(r => ({\n                result: r.result,\n                active: r.active\n              }))\n            })),\n            timestamp: Date.now()\n          }\n        };\n      } catch (err) {\n        ModuleLogger.error(`Error rolling formula: ${err}`);\n        socketManager?.send({\n          type: \"roll-result\",\n          requestId: requestId,\n          success: false,\n          error: `Failed to roll formula: ${(err as Error).message}`\n        });\n        return;\n      }\n\n      socketManager?.send({\n        type: \"roll-result\",\n        requestId: requestId,\n        success: true,\n        data: rollResult\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error in roll handler: ${error}`);\n      socketManager?.send({\n        type: \"roll-result\",\n        requestId: data.requestId,\n        success: false,\n        error: (error as Error).message || \"Unknown error occurred during roll\"\n      });\n    }\n  }\n});\n","export function parseFilterString(filterStr: string): Record<string, string> {\n    if (!filterStr.includes(':')) {\n      return { documentType: filterStr };\n    }\n    \n    const filters: Record<string, string> = {};\n    const parts = filterStr.split(',');\n    \n    for (const part of parts) {\n      if (part.includes(':')) {\n        const [key, value] = part.split(':');\n        if (key && value) {\n          filters[key.trim()] = value.trim();\n        }\n      }\n    }\n    \n    return filters;\n}\n\nexport function matchesAllFilters(result: any, filters: Record<string, string>): boolean {\n    for (const [key, value] of Object.entries(filters)) {\n      if (!value) continue;\n      \n      // Special handling for resultType (constructor name)\n      if (key === \"resultType\") {\n        const itemConstructorName = result.item?.constructor?.name;\n        if (!itemConstructorName || itemConstructorName.toLowerCase() !== value.toLowerCase()) {\n          return false;\n        }\n        continue;\n      }\n      \n      // Special handling for package (compendium) paths\n      if (key === \"package\" && result.item) {\n        const packageValue = result.item.package;\n        if (!packageValue) return false;\n        \n        // Check if the package matches or if it's a part of the full path\n        if (packageValue.toLowerCase() !== value.toLowerCase() && \n            !(`Compendium.${packageValue}`.toLowerCase() === value.toLowerCase())) {\n          return false;\n        }\n        continue;\n      }\n      \n      // Special handling for folder references\n      if (key === \"folder\" && result.item) {\n        const folderValue = result.item.folder;\n        \n        // No folder when one is required\n        if (!folderValue && value) return false;\n        \n        // Folder exists, check various formats:\n        if (folderValue) {\n          const folderIdMatch = typeof folderValue === 'object' ? folderValue.id : folderValue;\n          \n          // Accept any of these formats:\n          // - Just the ID: \"zmAZJmay9AxvRNqh\"\n          // - Full Folder UUID: \"Folder.zmAZJmay9AxvRNqh\"\n          // - Object format with ID\n          if (value === folderIdMatch || \n              value === `Folder.${folderIdMatch}` ||\n              `Folder.${value}` === folderIdMatch) {\n            continue; // Match found, continue to next filter\n          }\n          \n          // If we get here, folder doesn't match\n          return false;\n        }\n        \n        continue;\n      }\n      \n      // Standard property handling\n      let propertyValue;\n      if (!key.includes('.') && result.item && result.item[key] !== undefined) {\n        propertyValue = result.item[key];\n      } else {\n        const parts = key.split('.');\n        let current = result;\n        \n        for (const part of parts) {\n          if (current === undefined || current === null) {\n            propertyValue = undefined;\n            break;\n          }\n          current = current[part];\n        }\n        \n        propertyValue = current;\n      }\n      \n      // If the property is missing or doesn't match, filter it out\n      if (propertyValue === undefined || \n          (typeof propertyValue === 'string' &&\n           propertyValue.toLowerCase() !== value.toLowerCase())) {\n        return false;\n      }\n    }\n    \n    return true;\n}","import { Router } from \"./baseRouter\";\nimport { ModuleLogger } from \"../../utils/logger\";\nimport { parseFilterString, matchesAllFilters } from \"../../utils/search\";\n\nexport const router = new Router(\"searchRouter\");\n\nrouter.addRoute({\n  actionType: \"search\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received search request:`, data);\n\n    try {\n      if (!window.QuickInsert) {\n        ModuleLogger.error(`QuickInsert not available`);\n        socketManager?.send({\n          type: \"search-result\",\n          requestId: data.requestId,\n          query: data.query,\n          error: \"QuickInsert not available\",\n          results: []\n        });\n        return;\n      }\n\n      if (!window.QuickInsert.hasIndex) {\n        ModuleLogger.info(`QuickInsert index not ready, forcing index creation`);\n        try {\n          window.QuickInsert.forceIndex();\n          await new Promise(resolve => setTimeout(resolve, 500));\n        } catch (error) {\n          ModuleLogger.error(`Failed to force QuickInsert index:`, error);\n          socketManager?.send({\n            type: \"search-result\",\n            requestId: data.requestId,\n            query: data.query,\n            error: \"QuickInsert index not ready\",\n            results: []\n          });\n          return;\n        }\n      }\n\n      let filterFunc = null;\n      if (data.filter) {\n        const filters = typeof data.filter === 'string' ? \n          parseFilterString(data.filter) : data.filter;\n\n        filterFunc = (result: any) => {\n          return matchesAllFilters(result, filters);\n        };\n      }\n\n      const filteredResults = await window.QuickInsert.search(data.query, filterFunc, 200);\n      ModuleLogger.info(`Search returned ${filteredResults.length} results`);\n\n      socketManager?.send({\n        type: \"search-result\",\n        requestId: data.requestId,\n        query: data.query,\n        filter: data.filter,\n        results: filteredResults.map(result => {\n          const item = result.item;\n\n          return {\n            documentType: item.documentType,\n            folder: item.folder,\n            id: item.id,\n            name: item.name,\n            package: item.package,\n            packageName: item.packageName,\n            subType: item.subType,\n            uuid: item.uuid,\n            icon: item.icon,\n            journalLink: item.journalLink,\n            tagline: item.tagline || \"\",\n            formattedMatch: result.formattedMatch || \"\",\n            resultType: item.constructor?.name\n          };\n        })\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error performing search:`, error);\n      socketManager?.send({\n        type: \"search-result\",\n        requestId: data.requestId,\n        query: data.query,\n        error: (error as Error).message,\n        results: []\n      });\n    }\n  }\n});\n","import { Router } from \"./baseRouter\";\nimport { ModuleLogger } from \"../../utils/logger\";\n\nexport const router = new Router(\"structureRouter\");\n\nrouter.addRoute({\n  actionType: \"structure\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received structure request with params:`, data);\n\n    try {\n      // Parse parameters with defaults\n      const includeEntityData = data.includeEntityData ?? false;\n      const path = data.path || null;\n      const recursive = data.recursive ?? false;\n      const recursiveDepth = data.recursiveDepth ?? 5;\n      const types = data.type ? (Array.isArray(data.types) ? data.types : [data.types]) : \n        [\"Scene\", \"Actor\", \"Item\", \"JournalEntry\", \"RollTable\", \"Cards\", \"Macro\", \"Playlist\"];\n\n      // Type mapping for game collections\n      const typeCollectionMap = {\n        \"Scene\": game.scenes,\n        \"Actor\": game.actors,\n        \"Item\": game.items,\n        \"JournalEntry\": game.journal,\n        \"RollTable\": game.tables,\n        \"Cards\": game.cards,\n        \"Macro\": game.macros,\n        \"Playlist\": game.playlists\n      };\n\n      // Helper function to get entity data\n      const getEntityData = (entity: any) => {\n        if (includeEntityData) {\n          return entity.toObject(false);\n        } else {\n          return {\n            uuid: entity.uuid,\n            name: entity.name,\n            id: entity.id,\n            type: entity.documentName\n          };\n        }\n      };\n\n      // Helper function to build folder structure recursively\n      const buildFolderStructure = (parentFolder: any, currentDepth: number = 0): any => {\n        if (!recursive || currentDepth >= recursiveDepth) {\n          return {};\n        }\n\n        const structure: any = {};\n        const allFolders = game.folders?.contents || [];\n\n        // Get child folders\n        const childFolders = allFolders.filter(f => \n          f.folder?.id === parentFolder?.id && types.includes(f.type)\n        );\n\n        for (const folder of childFolders) {\n          const folderKey = folder.name || folder.id;\n          structure[folderKey] = {\n            id: folder.id,\n            uuid: folder.uuid,\n            type: folder.type,\n            ...buildFolderStructure(folder, currentDepth + 1)\n          };\n\n          // Add entities in this folder\n          const folderEntities = folder.contents\n            .filter((entity: any) => types.includes(entity.documentName))\n            .map(getEntityData);\n\n          if (folderEntities.length > 0) {\n            structure[folderKey].entities = folderEntities;\n          }\n        }\n\n        return structure;\n      };\n\n      // Start building the response\n      let result: any = {};\n\n      if (path && path.startsWith(\"Compendium.\")) {\n        // Handle compendium path\n        const pack = game.packs.get(path.replace(\"Compendium.\", \"\"));\n        if (!pack) {\n          throw new Error(`Compendium not found: ${path}`);\n        }\n\n        const index = await pack.getIndex();\n        const entities = index.contents.map(entry => {\n          if (includeEntityData) {\n            return { ...entry };\n          } else {\n            return {\n              uuid: (entry as any).uuid || `${pack.collection}.${entry._id}`,\n              name: entry.name,\n              id: entry._id,\n              type: pack.documentName\n            };\n          }\n        });\n\n        result = {\n          compendium: {\n            name: pack.title,\n            type: pack.documentName,\n            entities\n          }\n        };\n      } else if (path && path.startsWith(\"Folder.\")) {\n        // Handle specific folder path\n        const folderMatch = path.match(/Folder\\.([a-zA-Z0-9]+)/);\n        if (!folderMatch) {\n          throw new Error(`Invalid folder path: ${path}`);\n        }\n\n        const folderId = folderMatch[1];\n        const startFolder = game.folders?.get(folderId);\n\n        if (!startFolder) {\n          throw new Error(`Folder not found: ${path}`);\n        }\n\n        if (!types.includes(startFolder.type)) {\n          throw new Error(`Folder type ${startFolder.type} not included in requested types`);\n        }\n\n        // Build structure starting from this folder\n        result.folders = buildFolderStructure(startFolder);\n        \n        // Add entities in the start folder\n        const folderEntities = startFolder.contents\n          .filter((entity: any) => types.includes(entity.documentName))\n          .map(getEntityData);\n\n        if (folderEntities.length > 0) {\n          result.entities = folderEntities;\n        }\n      } else {\n        // Handle root level structure\n        if (recursive) {\n          result.folders = buildFolderStructure(null);\n        } else {\n          // Non-recursive: just return folder info without nesting\n          const folders = game.folders?.contents || [];\n          result.folders = {};\n          \n          for (const type of types) {\n            const typeFolders = folders.filter(f => f.type === type && !f.folder);\n            for (const folder of typeFolders) {\n              const folderKey = folder.name || folder.id;\n              result.folders[folderKey] = {\n                id: folder.id,\n                uuid: folder.uuid,\n                type: folder.type\n              };\n\n              // Add entities in folder if requested\n              if (includeEntityData || !recursive) {\n                const folderEntities = folder.contents\n                  .filter((entity: any) => types.includes(entity.documentName))\n                  .map(getEntityData);\n\n                if (folderEntities.length > 0) {\n                  result.folders[folderKey].entities = folderEntities;\n                }\n              }\n            }\n          }\n        }\n\n        // Add root entities (entities without folders)\n        const rootEntities: any = {};\n        for (const type of types) {\n          const collection = typeCollectionMap[type as keyof typeof typeCollectionMap];\n          if (collection) {\n            const entities = (collection as any).filter((e: any) => !e.folder).map(getEntityData);\n            if (entities.length > 0) {\n              rootEntities[type.toLowerCase() + 's'] = entities;\n            }\n          }\n        }\n\n        if (Object.keys(rootEntities).length > 0) {\n          result.entities = rootEntities;\n        }\n\n        // Add compendium packs if requested, filtered by types\n        if (!path) { // Only show compendiums at root level\n          const compendiumPacks: any = {};\n          \n          for (const pack of game.packs.contents) {\n            // Filter compendiums by requested types\n            if (types.includes(pack.documentName)) {\n              const packKey = pack.title || pack.collection;\n              \n              compendiumPacks[packKey] = {\n                id: pack.collection,\n                name: pack.title,\n                type: pack.documentName,\n                uuid: `Compendium.${pack.collection}`\n              };\n\n              try {\n                const index = await pack.getIndex();\n                const entities = index.contents.map(entry => {\n                  if (includeEntityData) {\n                    return { ...entry };\n                  } else {\n                    return {\n                      uuid: (entry as any).uuid || `${pack.collection}.${entry._id}`,\n                      name: entry.name,\n                      id: entry._id,\n                      type: pack.documentName\n                    };\n                  }\n                });\n                \n                if (entities.length > 0) {\n                  compendiumPacks[packKey].entities = entities;\n                }\n              } catch (error) {\n                ModuleLogger.warn(`Failed to load entities for compendium ${pack.collection}:`, error);\n              }\n            }\n          }\n\n          if (Object.keys(compendiumPacks).length > 0) {\n            result.compendiumPacks = compendiumPacks;\n          }\n        }\n      }\n\n      socketManager?.send({\n        type: \"structure-result\",\n        requestId: data.requestId,\n        data: result\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error getting structure:`, error);\n      socketManager?.send({\n        type: \"structure-result\",\n        requestId: data.requestId,\n        error: (error as Error).message,\n        data: {}\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"get-folder\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received get-folder request for name: ${data.name}`);\n\n    try {\n      const folders = game.folders?.contents || [];\n      const folder = folders.find(f => f.name === data.name);\n\n      if (!folder) {\n        throw new Error(`Folder not found with name: ${data.name}`);\n      }\n\n      // Get folder contents\n      const contents = folder.contents.map(entity => ({\n        uuid: entity.uuid,\n        id: entity.id,\n        name: entity.name,\n        type: entity.documentName,\n        img: 'img' in entity ? entity.img : null\n      }));\n\n      socketManager?.send({\n        type: \"get-folder-result\",\n        requestId: data.requestId,\n        data: {\n          id: folder.id,\n          uuid: folder.uuid,\n          name: folder.name,\n          type: folder.type,\n          parentFolder: folder.folder?.id || null,\n          contents\n        }\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error getting folder:`, error);\n      socketManager?.send({\n        type: \"get-folder-result\",\n        requestId: data.requestId,\n        error: (error as Error).message,\n        data: null\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"create-folder\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received create-folder request:`, data);\n\n    try {\n      const folderData: any = {\n        name: data.name,\n        type: data.folderType\n      };\n\n      if (data.parentFolderId) {\n        const parentFolder = game.folders?.get(data.parentFolderId);\n        if (!parentFolder) {\n          throw new Error(`Parent folder not found with ID: ${data.parentFolderId}`);\n        }\n        folderData.folder = data.parentFolderId;\n      }\n\n      const folder = await Folder.create(folderData);\n\n      socketManager?.send({\n        type: \"create-folder-result\",\n        requestId: data.requestId,\n        data: {\n          id: folder!.id,\n          uuid: folder!.uuid,\n          name: folder!.name,\n          type: folder!.type,\n          parentFolder: folder!.folder?.id || null\n        }\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error creating folder:`, error);\n      socketManager?.send({\n        type: \"create-folder-result\",\n        requestId: data.requestId,\n        error: (error as Error).message,\n        data: null\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"delete-folder\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received delete-folder request:`, data);\n\n    try {\n      const folder = game.folders?.get(data.folderId);\n      if (!folder) {\n        throw new Error(`Folder not found with ID: ${data.folderId}`);\n      }\n\n      const deleteAll = data.deleteAll ?? false;\n      let entitiesDeleted = 0;\n      let foldersDeleted = 0;\n\n      // Helper function to recursively delete folders and count entities\n      const recursiveDelete = async (folderToDelete: any): Promise<{ entities: number, folders: number }> => {\n        let entityCount = 0;\n        let folderCount = 0;\n\n        // Get all child folders first\n        const allFolders = game.folders?.contents || [];\n        const childFolders = allFolders.filter(f => f.folder?.id === folderToDelete.id);\n\n        // Recursively delete child folders first\n        for (const childFolder of childFolders) {\n          const childCounts = await recursiveDelete(childFolder);\n          entityCount += childCounts.entities;\n          folderCount += childCounts.folders;\n        }\n\n        // Count and delete entities in this folder\n        const entitiesToDelete = folderToDelete.contents;\n        entityCount += entitiesToDelete.length;\n        \n        for (const entity of entitiesToDelete) {\n          await entity.delete();\n        }\n\n        // Delete the folder itself\n        await folderToDelete.delete();\n        folderCount += 1;\n\n        return { entities: entityCount, folders: folderCount };\n      };\n      \n      if (deleteAll) {\n        // Recursively delete the folder and all its contents\n        const counts = await recursiveDelete(folder);\n        entitiesDeleted = counts.entities;\n        foldersDeleted = counts.folders;\n      } else {\n        // Check if folder has any contents (entities or child folders) and refuse to delete if it does\n        const allFolders = game.folders?.contents || [];\n        const childFolders = allFolders.filter(f => f.folder?.id === folder.id);\n        \n        if (folder.contents.length > 0) {\n          throw new Error(`Folder contains ${folder.contents.length} entities. Use deleteAll=true to delete them or move them first.`);\n        }\n        \n        if (childFolders.length > 0) {\n          throw new Error(`Folder contains ${childFolders.length} child folders. Use deleteAll=true to delete them or move them first.`);\n        }\n\n        // Delete the empty folder\n        await folder.delete();\n        foldersDeleted = 1;\n      }\n\n      socketManager?.send({\n        type: \"delete-folder-result\",\n        requestId: data.requestId,\n        data: {\n          deleted: true,\n          folderId: data.folderId,\n          entitiesDeleted,\n          foldersDeleted\n        }\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error deleting folder:`, error);\n      socketManager?.send({\n        type: \"delete-folder-result\",\n        requestId: data.requestId,\n        error: (error as Error).message,\n        data: null\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"contents\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received contents request for path: ${data.path}`);\n\n    try {\n      let contents = [];\n\n      if (data.path.startsWith(\"Compendium.\")) {\n        // Handle compendium path\n        const pack = game.packs.get(data.path.replace(\"Compendium.\", \"\"));\n        if (!pack) {\n          throw new Error(`Compendium not found: ${data.path}`);\n        }\n\n        // Get the index if not already loaded\n        const index = await pack.getIndex();\n\n        // Return entries from the index\n        contents = index.contents.map(entry => {\n          return {\n            ...entry\n          };\n        });\n      } else {\n        // Handle folder path\n        // Extract folder ID from path like \"Folder.abcdef12345\"\n        const folderMatch = data.path.match(/Folder\\.([a-zA-Z0-9]+)/);\n        if (!folderMatch) {\n          throw new Error(`Invalid folder path: ${data.path}`);\n        }\n\n        const folderId = folderMatch[1];\n        const folder = game.folders?.get(folderId);\n\n        if (!folder) {\n          throw new Error(`Folder not found: ${data.path}`);\n        }\n\n        // Get entities in folder\n        contents = folder.contents.map(entity => {\n          return {\n            uuid: entity.uuid,\n            id: entity.id,\n            name: entity.name,\n            img: 'img' in entity ? entity.img : null,\n            type: entity.documentName\n          };\n        });\n      }\n\n      socketManager?.send({\n        type: \"contents-result\",\n        requestId: data.requestId,\n        path: data.path,\n        entities: contents\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error getting contents:`, error);\n      socketManager?.send({\n        type: \"contents-result\",\n        requestId: data.requestId,\n        path: data.path,\n        error: (error as Error).message,\n        entities: []\n      });\n    }\n  }\n});\n","/**\n * Shared version checking utilities for Foundry VTT\n */\n\n/**\n * Get the current Foundry VTT core version\n * @returns The current Foundry core version\n */\nexport function getFoundryVersion(): string {\n    return game.version;\n}\n\nexport function getFoundryVersionMajor(): number {\n    return parseInt(getFoundryVersion().split('.')[0], 10);\n}\n\n/**\n * Get the current game system version\n * @returns The current system version\n */\nexport function getSystemVersion(): string {\n    return (game.system as any).version;\n}\n\n/**\n * Get the current game system ID\n * @returns The current system ID\n */\nexport function getSystemId(): string {\n    return game.system.id;\n}\n\n/**\n * Get the current game system title\n * @returns The current system title\n */\nexport function getSystemTitle(): string {\n    return (game.system as any).title;\n}\n","import { Router } from \"./baseRouter\";\nimport { ModuleLogger } from \"../../utils/logger\";\nimport { getFoundryVersionMajor } from \"../../utils/version\";\n\nexport const router = new Router(\"sheetRouter\");\n\nrouter.addRoute({\n  actionType: \"get-sheet\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received sheet request for UUID: ${data.uuid}`);\n\n    if (getFoundryVersionMajor() > 12) {\n      ModuleLogger.error(`Foundry version ${getFoundryVersionMajor()} does not support this endpoint`);\n      socketManager?.send({\n        type: \"get-sheet-response\",\n        requestId: data.requestId,\n        data: { error: \"This endpoint is only supported in Foundry VTT version 12\" }\n      });\n      return;\n    }\n\n    try {\n      let actor: Actor | TokenDocument | null = null;\n      if (data.uuid) {\n        actor = await fromUuid(data.uuid) as Actor;\n      } else if (data.selected) {\n        const controlledTokens = canvas?.tokens?.controlled;\n        if (controlledTokens && controlledTokens.length > 0) {\n          if (data.actor) {\n            actor = controlledTokens[0].actor;\n          } else {\n            actor = controlledTokens[0].document;\n          }\n        }\n      }\n\n      if (!actor) {\n        ModuleLogger.error(`Entity not found for UUID: ${data.uuid}`);\n        socketManager?.send({\n          type: \"get-sheet-response\",\n          requestId: data.requestId,\n          data: { error: \"Entity not found\", uuid: data.uuid }\n        });\n        return;\n      }\n\n      const sheet = actor.sheet?.render(true) as ActorSheet;\n\n      setTimeout(async () => {\n        try {\n          if (!sheet.element || !sheet.element[0]) {\n            throw new Error(\"Failed to render actor sheet\");\n          }\n\n          let html = sheet.element[0].outerHTML;\n          let css = '';\n\n          const sheetAppId = String(sheet.appId);\n\n          const appStyles = document.querySelectorAll('style[data-appid]');\n          appStyles.forEach(style => {\n            const styleAppId = (style as HTMLElement).dataset.appid;\n            if (styleAppId === sheetAppId) {\n              css += style.textContent + '\\n';\n            }\n          });\n\n          const systemStyles = document.querySelectorAll(`style[id^=\"system-${(actor as any).type}\"]`);\n          systemStyles.forEach(style => {\n            css += style.textContent + '\\n';\n          });\n\n          const tempDiv = document.createElement('div');\n          tempDiv.innerHTML = html;\n\n          const classNames = new Set<string>();\n          const ids = new Set<string>();\n\n          function extractClassesAndIds(element: Element) {\n            if (element.classList && element.classList.length) {\n              element.classList.forEach(className => classNames.add(className));\n            }\n\n            if (element.id) {\n              ids.add(element.id);\n            }\n\n            for (let i = 0; i < element.children.length; i++) {\n              extractClassesAndIds(element.children[i]);\n            }\n          }\n\n          extractClassesAndIds(tempDiv);\n\n          const uniqueClassNames = Array.from(classNames);\n          const uniqueIds = Array.from(ids);\n\n          ModuleLogger.debug(`Extracted ${uniqueClassNames.length} unique classes and ${uniqueIds.length} unique IDs`);\n\n          const allStyles = document.querySelectorAll('style');\n          const allLinks = document.querySelectorAll('link[rel=\"stylesheet\"]');\n\n          allStyles.forEach(style => {\n            if (style.dataset.appid && style.dataset.appid === sheetAppId) {\n              return;\n            }\n\n            const styleContent = style.textContent || '';\n\n            const isRelevant = uniqueClassNames.some(className => \n              styleContent.includes(`.${className}`)) || \n              uniqueIds.some(id => styleContent.includes(`#${id}`)) ||\n              styleContent.includes('.window-app') || \n              styleContent.includes('.sheet') || \n              styleContent.includes('.actor-sheet') ||\n              styleContent.includes(`.${(actor as any).type}-sheet`);\n\n            if (isRelevant) {\n              ModuleLogger.debug(`Adding relevant inline style`);\n              css += styleContent + '\\n';\n            }\n          });\n\n          const stylesheetPromises = Array.from(allLinks).map(async (link) => {\n            try {\n              const href = link.getAttribute('href');\n              if (!href) return '';\n\n              if (href.includes('fonts.googleapis.com')) return '';\n\n              ModuleLogger.debug(`Fetching external CSS from: ${href}`);\n              const fullUrl = href.startsWith('http') ? href : \n                              href.startsWith('/') ? `${window.location.origin}${href}` : \n                              `${window.location.origin}/${href}`;\n\n              const response = await fetch(fullUrl);\n              if (!response.ok) {\n                ModuleLogger.warn(`Failed to fetch CSS: ${fullUrl}, status: ${response.status}`);\n                return '';\n              }\n\n              const styleContent = await response.text();\n              return styleContent;\n            } catch (e) {\n              ModuleLogger.warn(`Failed to fetch external CSS: ${e}`);\n              return '';\n            }\n          });\n\n          const baseUrl = window.location.origin;\n          ModuleLogger.debug(`Base URL for fetching CSS: ${baseUrl}`);\n\n          const coreStylesheets = [\n            `${baseUrl}/css/style.css`,\n            `${baseUrl}/styles/style.css`,\n            `${baseUrl}/styles/foundry.css`,\n            `${baseUrl}/ui/sheets.css`,\n            `${baseUrl}/game/styles/foundry.css`,\n            `${baseUrl}/game/ui/sheets.css`,\n            `${baseUrl}/systems/${(game as Game).system.id}/system.css`,\n            `${baseUrl}/systems/${(game as Game).system.id}/styles/system.css`,\n            `${baseUrl}/game/systems/${(game as Game).system.id}/system.css`,\n            `${baseUrl}/game/systems/${(game as Game).system.id}/styles/system.css`\n          ];\n\n          ModuleLogger.debug(`All stylesheet links in document:`, \n            Array.from(document.querySelectorAll('link[rel=\"stylesheet\"]'))\n              .map(link => link.getAttribute('href'))\n              .filter(Boolean)\n          );\n\n          const existingCSSPaths = Array.from(document.querySelectorAll('link[rel=\"stylesheet\"]'))\n            .map(link => link.getAttribute('href'))\n            .filter((href): href is string => \n              href !== null && \n              !href.includes('fonts.googleapis.com') && \n              !href.includes('//'));\n\n          coreStylesheets.push(...existingCSSPaths);\n\n          ModuleLogger.debug(`All style elements in document:`, \n            document.querySelectorAll('style').length\n          );\n\n          const corePromises = coreStylesheets.map(async (path) => {\n            try {\n              ModuleLogger.debug(`Fetching core CSS from: ${path}`);\n              const response = await fetch(path);\n              if (!response.ok) {\n                ModuleLogger.warn(`Failed to fetch CSS: ${path}, status: ${response.status}`);\n                return '';\n              }\n\n              ModuleLogger.info(`Successfully loaded CSS from: ${path}`);\n              return await response.text();\n            } catch (e) {\n              ModuleLogger.warn(`Failed to fetch core CSS: ${e}`);\n              return '';\n            }\n          });\n\n          const allPromises = [...stylesheetPromises, ...corePromises];\n          const externalStyles = await Promise.all(allPromises);\n          externalStyles.forEach(style => {\n            css += style + '\\n';\n          });\n\n          if (css.length < 100) {\n            ModuleLogger.warn(`CSS fetch failed or returned minimal content. Adding fallback styles.`);\n            css += `\n              .window-app {\n                font-family: \"Signika\", sans-serif;\n                background: #f0f0e0;\n                border-radius: 5px;\n                box-shadow: 0 0 20px #000;\n                color: #191813;\n              }\n              .window-content {\n                background: rgba(255, 255, 240, 0.9);\n                padding: 8px;\n                overflow-y: auto;\n                background: url(${window.location.origin}/ui/parchment.jpg) repeat;\n              }\n              input, select, textarea {\n                border: 1px solid #7a7971;\n                background: rgba(255, 255, 255, 0.8);\n              }\n              button {\n                background: rgba(0, 0, 0, 0.1);\n                border: 1px solid #7a7971;\n                border-radius: 3px;\n                cursor: pointer;\n              }\n              .profile-img {\n                border: none;\n                max-width: 100%;\n                max-height: 220px;\n              }\n            `;\n          }\n\n          ModuleLogger.debug(`Collected CSS: ${css.length} bytes`);\n\n          html = html.replace(/src=\"([^\"]+)\"/g, (match, src) => {\n            if (src.startsWith('http')) return match;\n            if (src.startsWith('/')) return `src=\"${window.location.origin}${src}\"`;\n            return `src=\"${window.location.origin}/${src}\"`;\n          });\n\n          css = css.replace(/url\\(['\"]?([^'\")]+)['\"]?\\)/g, (match, url) => {\n            if (url.startsWith('http') || url.startsWith('data:')) return match;\n            if (url.startsWith('/')) return `url('${window.location.origin}${url}')`;\n            return `url('${window.location.origin}/${url}')`;\n          });\n\n          sheet.close();\n\n          socketManager?.send({\n            type: \"get-sheet-response\",\n            requestId: data.requestId,\n            data: { html, css, uuid: data.uuid }\n          });\n\n          ModuleLogger.debug(`Sent actor sheet HTML response with requestId: ${data.requestId}`);\n          ModuleLogger.debug(`HTML length: ${html.length}, CSS length: ${css.length}`);\n        } catch (renderError) {\n          ModuleLogger.error(`Error capturing actor sheet HTML:`, renderError);\n          socketManager?.send({\n            type: \"get-sheet-response\",\n            requestId: data.requestId,\n            data: { error: \"Failed to capture actor sheet HTML\", uuid: data.uuid }\n          });\n\n          if (sheet && typeof sheet.close === 'function') {\n            sheet.close();\n          }\n        }\n      }, 500);\n\n    } catch (error) {\n      ModuleLogger.error(`Error rendering actor sheet:`, error);\n      socketManager?.send({\n        type: \"get-sheet-response\",\n        requestId: data.requestId,\n        data: { error: \"Failed to render actor sheet\", uuid: data.uuid }\n      });\n    }\n  }\n});","import { Router } from \"./baseRouter\";\nimport { ModuleLogger } from \"../../utils/logger\";\n\nexport const router = new Router(\"macroRouter\");\n\nrouter.addRoute({\n  actionType: \"macros\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received request for macros`);\n\n    try {\n      const macros = game.macros?.contents.map(macro => {\n        return {\n          uuid: macro.uuid,\n          id: macro.id,\n          name: macro.name,\n          type: (macro as any).type || (macro as any).data?.type || \"unknown\",\n          author: (macro as any).author?.name || \"unknown\",\n          command: (macro as any).command || \"\",\n          img: (macro as any).img,\n          scope: (macro as any).scope,\n          canExecute: (macro as any).canExecute\n        };\n      }) || [];\n\n      socketManager?.send({\n        type: \"macros-result\",\n        requestId: data.requestId,\n        macros\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error getting macros list:`, error);\n      socketManager?.send({\n        type: \"macros-result\",\n        requestId: data.requestId,\n        error: (error as Error).message,\n        macros: []\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"macro-execute\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received request to execute macro: ${data.uuid}`);\n\n    try {\n      if (!data.uuid) {\n        throw new Error(\"Macro UUID is required\");\n      }\n\n      const macro = await fromUuid(data.uuid) as Macro;\n      if (!macro) {\n        throw new Error(`Macro not found with UUID: ${data.uuid}`);\n      }\n\n      if (!(macro instanceof CONFIG.Macro.documentClass)) {\n        throw new Error(`Entity with UUID ${data.uuid} is not a macro`);\n      }\n\n      if (!macro.canExecute) {\n        throw new Error(`Macro '${macro.name}' cannot be executed by the current user`);\n      }\n\n      const args = data.args || {};\n\n      let result;\n      if (typeof args === \"object\") {\n        result = await macro.execute({ args } as any);\n      } else {\n        result = await macro.execute();\n      }\n\n      socketManager?.send({\n        type: \"macro-execute-result\",\n        requestId: data.requestId,\n        uuid: data.uuid,\n        success: true,\n        result: typeof result === 'object' ? result : { value: result }\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error executing macro:`, error);\n      socketManager?.send({\n        type: \"macro-execute-result\",\n        requestId: data.requestId,\n        uuid: data.uuid || \"\",\n        success: false,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n","import { Router } from \"./baseRouter\";\nimport { ModuleLogger } from \"../../utils/logger\";\n\nexport const router = new Router(\"utilityRouter\");\n\nrouter.addRoute({\n  actionType: \"execute-js\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received execute-js request:`, data);\n\n    try {\n      const { script, requestId } = data;\n\n      if (!script || typeof script !== \"string\") {\n        throw new Error(\"Invalid script provided\");\n      }\n\n      let result;\n      try {\n        result = await (async () => {\n          return eval(`(async () => { ${script} })()`);\n        })();\n      } catch (executionError) {\n        const errorMessage = executionError instanceof Error ? executionError.message : String(executionError);\n        throw new Error(`Error executing script: ${errorMessage}`);\n      }\n\n      socketManager?.send({\n        type: \"execute-js-result\",\n        requestId,\n        success: true,\n        result\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error in execute-js handler:`, error);\n      socketManager?.send({\n        type: \"execute-js-result\",\n        requestId: data.requestId,\n        success: false,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"select\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received select entities request:`, data);\n\n    try {\n      const scene = game.scenes?.active;\n      if (!scene) {\n        throw new Error(\"No active scene found\");\n      }\n\n      if (data.overwrite) {\n        canvas?.tokens?.releaseAll();\n      }\n\n      // Use a Set to track unique tokens by UUID to avoid duplicates\n      const targetSet = new Set<TokenDocument>();\n      \n      if (data.all) {\n        const allTokens = scene.tokens?.contents || [];\n        allTokens.forEach(token => targetSet.add(token));\n      }\n      if (data.uuids && Array.isArray(data.uuids)) {\n        const matchingTokens = scene.tokens?.filter(token => \n          data.uuids.includes(token.uuid)\n        ) || [];\n        matchingTokens.forEach(token => targetSet.add(token));\n      }\n      if (data.name) {\n        const matchingTokens = scene.tokens?.filter(token => \n          token.name?.toLowerCase() === data.name?.toLowerCase()\n        ) || [];\n        matchingTokens.forEach(token => targetSet.add(token));\n      }\n      if (data.data) {\n        const matchingTokens = scene.tokens?.filter(token => \n          Object.entries(data.data).every(([key, value]) => {\n            if (key.startsWith(\"actor.\") && token.actor) {\n              const actorKey = key.replace(\"actor.\", \"\");\n              return getProperty(token.actor, actorKey) === value;\n            }\n            const tokenData = token.toObject();\n            return getProperty(tokenData, key) === value;\n          })\n        ) || [];\n        matchingTokens.forEach(token => targetSet.add(token));\n      }\n\n      // Convert Set back to array\n      const targets = Array.from(targetSet);\n\n      if (targets.length === 0) {\n        throw new Error(\"No matching entities found\");\n      }\n\n      for (const token of targets) {\n        const t = token.id ? canvas?.tokens?.get(token.id) : null;\n        if (t) {\n          t.control({ releaseOthers: false });\n        }\n      }\n\n      const selectedUuids = targets.map(token => token.uuid);\n\n      socketManager?.send({\n        type: \"select-result\",\n        requestId: data.requestId,\n        success: true,\n        count: targets.length,\n        message: `${targets.length} entities selected`,\n        selected: selectedUuids\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error selecting entities:`, error);\n      socketManager?.send({\n        type: \"select-result\",\n        requestId: data.requestId,\n        success: false,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"selected\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received get selected entities request:`, data);\n\n    try {\n      const scene = game.scenes?.active;\n      if (!scene) {\n        throw new Error(\"No active scene found\");\n      }\n\n      const selectedTokens = canvas?.tokens?.controlled || [];\n      const selectedUuids = selectedTokens.map(token => ({\n        tokenUuid: token.document.uuid,\n        actorUuid: token.actor?.uuid || null\n      }));\n\n      socketManager?.send({\n        type: \"selected-result\",\n        requestId: data.requestId,\n        success: true,\n        selected: selectedUuids\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error getting selected entities:`, error);\n      socketManager?.send({\n        type: \"selected-result\",\n        requestId: data.requestId,\n        success: false,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n","import { Router } from \"./baseRouter\";\nimport { ModuleLogger } from \"../../utils/logger\";\n\nexport const router = new Router(\"fileSystemRouter\");\n\nrouter.addRoute({\n  actionType: \"file-system\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received get file system request:`, data);\n\n    try {\n      const path = data.path || \"\";\n      const source = data.source || \"data\";\n      const recursive = !!data.recursive;\n\n      const result = await FilePicker.browse(source, path);\n\n      const dirs = Array.isArray(result.dirs) ? result.dirs.map((dir: string) => ({\n        name: dir.split('/').pop() || dir,\n        path: dir,\n        type: 'directory'\n      })) : [];\n\n      const files = Array.isArray(result.files) ? result.files.map((file: string) => ({\n        name: file.split('/').pop() || file,\n        path: file,\n        type: 'file'\n      })) : [];\n\n      let subdirs: Array<{name: string, path: string, type: string}> = [];\n      if (recursive && dirs.length > 0) {\n        for (const dir of dirs) {\n          try {\n            const subResult = await FilePicker.browse(source, dir.path);\n\n            const subDirs = Array.isArray(subResult.dirs) ? subResult.dirs.map((subdir: string) => ({\n              name: subdir.split('/').pop() || subdir,\n              path: subdir,\n              type: 'directory'\n            })) : [];\n\n            const subFiles = Array.isArray(subResult.files) ? subResult.files.map((file: string) => ({\n              name: file.split('/').pop() || file,\n              path: file,\n              type: 'file'\n            })) : [];\n\n            subdirs = subdirs.concat(subDirs, subFiles);\n\n            if (recursive === true && subDirs.length > 0 && dir.path.split('/').length < 3) {\n              for (const subDir of subDirs) {\n                try {\n                  const deepResult = await FilePicker.browse(source, subDir.path);\n\n                  const deepDirs = Array.isArray(deepResult.dirs) ? deepResult.dirs.map((deepdir: string) => ({\n                    name: deepdir.split('/').pop() || deepdir,\n                    path: deepdir,\n                    type: 'directory'\n                  })) : [];\n\n                  const deepFiles = Array.isArray(deepResult.files) ? deepResult.files.map((file: string) => ({\n                    name: file.split('/').pop() || file,\n                    path: file,\n                    type: 'file'\n                  })) : [];\n\n                  subdirs = subdirs.concat(deepDirs, deepFiles);\n                } catch (deepError) {\n                  ModuleLogger.error(`Error processing deep subdirectory ${subDir.path}:`, deepError);\n                }\n              }\n            }\n          } catch (error) {\n            ModuleLogger.error(`Error processing subdirectory ${dir.path}:`, error);\n          }\n        }\n      }\n\n      const results = [...dirs, ...files];\n      if (recursive) {\n        results.push(...subdirs);\n      }\n\n      socketManager?.send({\n        type: \"file-system-result\",\n        requestId: data.requestId,\n        success: true,\n        path,\n        source,\n        results,\n        recursive\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error getting file system:`, error);\n      socketManager?.send({\n        type: \"file-system-result\",\n        requestId: data.requestId,\n        success: false,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"upload-file\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received upload file request:`, data);\n\n    try {\n      const { path, filename, source, fileData, mimeType, binaryData, overwrite } = data;\n\n      if (!path || !filename) {\n        throw new Error(\"Missing required parameters (path, filename)\");\n      }\n\n      let file;\n\n      if (binaryData) {\n        if (!Array.isArray(binaryData) || binaryData.length === 0) {\n          throw new Error(\"Invalid binary data: must be non-empty array\");\n        }\n        const bytes = new Uint8Array(binaryData);\n        const blob = new Blob([bytes], { type: mimeType || 'application/octet-stream' });\n        file = new File([blob], filename, { type: mimeType || 'application/octet-stream' });\n        ModuleLogger.info(`Created file from binary data: ${bytes.length} bytes`);\n      } else if (fileData) {\n        if (!fileData.includes(',') || !fileData.startsWith('data:')) {\n          throw new Error(\"Invalid file data format: must be data URL with base64 content\");\n        }\n        \n        const base64Data = fileData.split(',')[1];\n        if (!base64Data) {\n          throw new Error(\"No base64 data found in file data\");\n        }\n        \n        let binaryString;\n        try {\n          binaryString = atob(base64Data);\n        } catch (error) {\n          throw new Error(`Invalid base64 data: ${(error as Error).message}`);\n        }\n        \n        if (binaryString.length === 0) {\n          throw new Error(\"Decoded file data is empty\");\n        }\n        \n        const bytes = new Uint8Array(binaryString.length);\n        for (let i = 0; i < binaryString.length; i++) {\n          bytes[i] = binaryString.charCodeAt(i);\n        }\n        const blob = new Blob([bytes], { type: mimeType || 'application/octet-stream' });\n        file = new File([blob], filename, { type: mimeType || 'application/octet-stream' });\n        ModuleLogger.info(`Created file from base64 data: ${bytes.length} bytes`);\n      } else {\n        throw new Error(\"Missing file data (either binaryData or fileData is required)\");\n      }\n\n      const uploadSource = source || \"data\";\n\n      // Create directories if they don't exist\n      if (path && path !== '/' && path !== '') {\n        try {\n          const directories = path.split('/').filter((dir: string) => dir.length > 0);\n          let currentPath = '';\n\n          for (const directory of directories) {\n            currentPath = currentPath ? `${currentPath}/${directory}` : directory;\n            try {\n              await FilePicker.createDirectory(uploadSource, currentPath);\n              ModuleLogger.info(`Created/verified directory: ${currentPath}`);\n            } catch (createDirError) {\n              const errorMessage = (createDirError as any).message || String(createDirError);\n              if (!errorMessage.includes(\"already exists\")) {\n                ModuleLogger.error(`Error creating directory ${currentPath}:`, createDirError);\n                throw new Error(`Could not create directory '${currentPath}': ${errorMessage}`);\n              }\n            }\n          }\n        } catch (createDirError) {\n          ModuleLogger.error(`Error creating directories for path '${path}':`, createDirError);\n          throw new Error(`Could not create directory structure: ${(createDirError as Error).message}`);\n        }\n      }\n\n      // Check if file already exists\n      let existingFile = null;\n      try {\n        const filePath = path && path !== '/' ? `${path}/${filename}` : filename;\n        existingFile = await FilePicker.browse(uploadSource, filePath);\n      } catch (e) {\n        // File does not exist, which is fine\n      }\n\n      if (existingFile && !overwrite) {\n        throw new Error(\"File already exists. Set overwrite to true to replace it.\");\n      }\n\n      // Upload the file\n      const result = await FilePicker.upload(uploadSource, path, file);\n      \n      // Validate the upload result\n      if (!result) {\n        throw new Error(\"FilePicker.upload returned null/undefined result\");\n      }\n      \n      const uploadedPath = result && typeof result === 'object' && 'path' in result ? result.path : `${path}/${filename}`;\n      \n      ModuleLogger.info(`File uploaded successfully: ${uploadedPath}`);\n      \n      socketManager?.send({\n        type: \"upload-file-result\",\n        requestId: data.requestId,\n        success: true,\n        path: uploadedPath\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error uploading file:`, error);\n      socketManager?.send({\n        type: \"upload-file-result\",\n        requestId: data.requestId,\n        success: false,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n\nrouter.addRoute({\n  actionType: \"download-file\",\n  handler: async (data, context) => {\n    const socketManager = context?.socketManager;\n    ModuleLogger.info(`Received download file request:`, data);\n\n    try {\n      const { path } = data;\n\n      if (!path) {\n        throw new Error(\"Missing required parameter (path)\");\n      }\n\n      const response = await fetch(path.startsWith('http') ? path : foundry.utils.getRoute(path));\n\n      if (!response.ok) {\n        throw new Error(`Failed to download file: ${response.status} ${response.statusText}`);\n      }\n\n      const blob = await response.blob();\n      const reader = new FileReader();\n      const fileData = await new Promise<string>((resolve, reject) => {\n        reader.onload = () => resolve(reader.result as string);\n        reader.onerror = reject;\n        reader.readAsDataURL(blob);\n      });\n\n      socketManager?.send({\n        type: \"download-file-result\",\n        requestId: data.requestId,\n        success: true,\n        path,\n        fileData,\n        filename: path.split('/').pop() || 'file',\n        mimeType: blob.type\n      });\n    } catch (error) {\n      ModuleLogger.error(`Error downloading file:`, error);\n      socketManager?.send({\n        type: \"download-file-result\",\n        requestId: data.requestId,\n        success: false,\n        error: (error as Error).message\n      });\n    }\n  }\n});\n","import { Router } from \"./baseRouter\";\nimport { ModuleLogger } from \"../../utils/logger\";\n\nexport const router = new Router(\"dnd5eRouter\");\n\nHooks.once('init', () => {\n    const isDnd5e = game.system.id === \"dnd5e\";\n\n    if (isDnd5e) {\n        // Get an actor's resources, spells, items, and features\n        router.addRoute({\n            actionType: \"get-actor-details\",\n            handler: async (data, context) => {\n                const socketManager = context?.socketManager;\n                ModuleLogger.info(`Received get-actor-details request:`, data);\n\n                try {\n                    const { actorUuid, details } = data;\n                    if (!actorUuid) throw new Error(\"actorUuid is required\");\n                    if (!details || !Array.isArray(details) || details.length === 0) {\n                        throw new Error(\"details array is required and cannot be empty\");\n                    }\n\n                    const actor: any = await fromUuid(actorUuid);\n                    if (!actor) throw new Error(`Actor not found with UUID: ${actorUuid}`);\n\n                    const results: any = { uuid: actorUuid };\n\n                    if (details.includes(\"resources\")) {\n                        results.resources = actor.system.resources;\n                    }\n\n                    if (details.includes(\"spells\")) {\n                        results.spells = actor.items.filter((i: any) => i.type === 'spell');\n                    }\n\n                    if (details.includes(\"items\")) {\n                        results.items = actor.items.filter((i: any) => ['weapon', 'equipment', 'consumable', 'tool', 'loot', 'backpack'].includes(i.type));\n                    }\n\n                    if (details.includes(\"features\")) {\n                        results.features = actor.items.filter((i: any) => ['feat', 'background', 'class'].includes(i.type));\n                    }\n\n                    socketManager?.send({\n                        type: \"get-actor-details-result\",\n                        requestId: data.requestId,\n                        data: results,\n                    });\n\n                } catch (error) {\n                    ModuleLogger.error(`Error in get-actor-details:`, error);\n                    socketManager?.send({\n                        type: \"get-actor-details-result\",\n                        requestId: data.requestId,\n                        error: (error as Error).message,\n                    });\n                }\n            }\n        });\n\n        // Add or remove charges from an item\n        router.addRoute({\n            actionType: \"modify-item-charges\",\n            handler: async (data, context) => {\n                const socketManager = context?.socketManager;\n                ModuleLogger.info(`Received modify-item-charges request:`, data);\n\n                try {\n                    const { actorUuid, itemUuid, itemName, amount } = data;\n                    if (!actorUuid) throw new Error(\"actorUuid is required\");\n                    if (!itemUuid && !itemName) throw new Error(\"itemUuid or itemName is required\");\n                    if (typeof amount !== 'number') throw new Error(\"amount must be a number\");\n\n                    const actor: any = await fromUuid(actorUuid);\n                    if (!actor) throw new Error(`Actor not found with UUID: ${actorUuid}`);\n\n                    let item: any = null;\n                    if (itemUuid) {\n                        item = actor.items.get(itemUuid.split('.').pop());\n                    } else if (itemName) {\n                        item = actor.items.find((i: any) => i.name.toLowerCase() === itemName.toLowerCase());\n                    }\n\n                    if (!item) throw new Error(`Item not found on actor ${actor.name}`);\n\n                    const uses = item.system.uses || {};\n                    const currentSpent = uses.spent || 0;\n                    const currentValue = uses.value ?? uses.max ?? 0;\n                    const maxUses = uses.max || 0;\n\n                    // When amount is negative (using a charge), spent increases and value decreases.\n                    const newSpent = Math.max(0, Math.min(maxUses, currentSpent - amount));\n                    const newValue = Math.max(0, Math.min(maxUses, currentValue + amount));\n\n                    // Create a full update payload to avoid silent failures with partial data\n                    const updatePayload = {\n                        system: {\n                            ...item.system,\n                            uses: {\n                                ...item.system.uses,\n                                spent: newSpent,\n                                value: newValue\n                            }\n                        }\n                    };\n                    \n                    await item.update(updatePayload);\n\n                    socketManager?.send({\n                        type: \"modify-item-charges-result\",\n                        requestId: data.requestId,\n                        data: {\n                            itemUuid: item.uuid,\n                            oldCharges: currentValue,\n                            newCharges: newValue,\n                        },\n                    });\n\n                } catch (error) {\n                    ModuleLogger.error(`Error in modify-item-charges:`, error);\n                    socketManager?.send({\n                        type: \"modify-item-charges-result\",\n                        requestId: data.requestId,\n                        error: (error as Error).message,\n                    });\n                }\n            }\n        });\n\n        // Use an item, spell, or feature for an actor\n        const useAbilityHandler = async (data: any, context: any, abilityType: string | null) => {\n            const socketManager = context?.socketManager;\n            const actionType = abilityType ? `use-${abilityType}` : 'use-ability';\n            ModuleLogger.info(`Received ${actionType} request:`, data);\n\n            try {\n                const { actorUuid, abilityUuid, abilityName, targetUuid } = data;\n                if (!actorUuid) throw new Error(\"actorUuid is required\");\n                if (!abilityUuid && !abilityName) throw new Error(\"abilityUuid or abilityName is required\");\n\n                const actor: any = await fromUuid(actorUuid);\n                if (!actor) throw new Error(`Actor not found with UUID: ${actorUuid}`);\n\n                let ability: any = null;\n                if (abilityUuid) {\n                    ability = await fromUuid(abilityUuid);\n                } else if (abilityName) {\n                    const allAbilities = actor.items;\n                    ability = allAbilities.find((i: any) => {\n                        const nameMatch = i.name.toLowerCase() === abilityName.toLowerCase();\n                        if (!nameMatch) return false;\n\n                        if (!abilityType) return true; // For /use-ability, no type filter\n\n                        if (abilityType === 'item') {\n                            return i.type !== 'feat' && i.type !== 'spell';\n                        }\n                        \n                        return i.type === abilityType; // For /use-feature and /use-spell\n                    });\n                }\n\n                if (!ability) throw new Error(`Ability not found on actor ${actor.name}`);\n\n                let targetToken = null;\n                if (targetUuid) {\n                    const targetDoc: any = await fromUuid(targetUuid);\n                    if (targetDoc && targetDoc.documentName === \"Token\") {\n                        targetToken = targetDoc;\n                    } else if (targetDoc && targetDoc.documentName === \"Actor\") {\n                        const scene = game.scenes?.active;\n                        if (scene) {\n                            const tokens = scene.tokens?.filter(t => t.actor?.id === targetDoc.id);\n                            if (tokens && tokens.length > 0) {\n                                targetToken = tokens[0];\n                            }\n                        }\n                    }\n                    if (targetToken && canvas?.tokens) {\n                        game.user?.targets.forEach(t => t.setTarget(false, { releaseOthers: false }));\n                        const tokenObject = canvas.tokens.get(targetToken.id);\n                        if(tokenObject) {\n                            tokenObject.setTarget(true, { releaseOthers: true });\n                        }\n                    }\n                }\n                \n                const useResult = await ability.use();\n\n                socketManager?.send({\n                    type: `${actionType}-result`,\n                    requestId: data.requestId,\n                    data: {\n                        uuid: actorUuid,\n                        ability: ability.name,\n                        result: useResult ? useResult.id : null\n                    },\n                });\n\n            } catch (error) {\n                ModuleLogger.error(`Error in ${actionType}:`, error);\n                socketManager?.send({\n                    type: `${actionType}-result`,\n                    requestId: data.requestId,\n                    error: (error as Error).message,\n                });\n            }\n        };\n\n        router.addRoute({\n            actionType: \"use-ability\",\n            handler: (data, context) => useAbilityHandler(data, context, null)\n        });\n\n        router.addRoute({\n            actionType: \"use-feature\",\n            handler: (data, context) => useAbilityHandler(data, context, 'feat')\n        });\n\n        router.addRoute({\n            actionType: \"use-spell\",\n            handler: (data, context) => useAbilityHandler(data, context, 'spell')\n        });\n\n        router.addRoute({\n            actionType: \"use-item\",\n            handler: (data, context) => useAbilityHandler(data, context, 'item')\n        });\n\n        // Modify actor experience\n        router.addRoute({\n            actionType: \"modify-experience\",\n            handler: async (data, context) => {\n                const socketManager = context?.socketManager;\n                ModuleLogger.info(`Received modify-experience request:`, data);\n\n                try {\n                    const { actorUuid, selected, amount } = data;\n                    if (!actorUuid && !selected) throw new Error(\"Either actorUuid or selected must be provided\");\n                    if (typeof amount !== 'number') throw new Error(\"amount must be a number\");\n\n                    let actor: any = null;\n                    if (actorUuid) {\n                        actor = await fromUuid(actorUuid);\n                    } else if (selected) {\n                        const selectedTokens = canvas.tokens?.controlled;\n                        if (!selectedTokens || selectedTokens.length === 0) {\n                            throw new Error(\"No token selected\");\n                        }\n                        if (selectedTokens.length > 1) {\n                            ModuleLogger.warn(\"Multiple tokens selected, using the first one.\");\n                        }\n                        actor = selectedTokens[0].actor;\n                    }\n\n                    if (!actor) throw new Error(`Actor not found`);\n\n                    const currentXp = actor.system.details.xp.value;\n                    const newXp = currentXp + amount;\n\n                    await actor.update({ \"system.details.xp.value\": newXp });\n\n                    socketManager?.send({\n                        type: \"modify-experience-result\",\n                        requestId: data.requestId,\n                        data: {\n                            actorUuid: actor.uuid,\n                            oldXp: currentXp,\n                            newXp: newXp,\n                        },\n                    });\n\n                } catch (error) {\n                    ModuleLogger.error(`Error in modify-experience:`, error);\n                    socketManager?.send({\n                        type: \"modify-experience-result\",\n                        requestId: data.requestId,\n                        error: (error as Error).message,\n                    });\n                }\n            }\n        });\n\n    }\n});","import {Router} from \"./baseRouter\"\nimport {router as PingPongRouter} from \"./pingPong\"\nimport {router as EntityRouter} from \"./entity\"\nimport {router as EncounterRouter} from \"./encounter\"\nimport {router as RollRouter} from \"./roll\"\nimport {router as SearchRouter} from \"./search\"\nimport {router as StructureRouter} from \"./structure\"\nimport {router as SheetRouter} from \"./sheet\"\nimport {router as MacroRouter} from \"./macro\"\nimport {router as UtilityRouter} from \"./utility\"\nimport {router as FileSystemRouter} from \"./fileSystem\"\nimport {router as Dnd5eRouter} from \"./dnd5e\"\n\nexport const routers: Router[] = [\n    PingPongRouter,\n    EntityRouter,\n    EncounterRouter,\n    RollRouter,\n    SearchRouter,\n    StructureRouter,\n    SheetRouter,\n    MacroRouter,\n    UtilityRouter,\n    FileSystemRouter,\n    Dnd5eRouter\n]\n","import { moduleId } from \"../constants\";\nimport { FoundryRestApi } from \"../types\";\nimport { ModuleLogger } from \"../utils/logger\";\nimport { WebSocketManager } from \"./webSocketManager\";\nimport { routers } from \"./routers/all\"\nimport { Router } from \"./routers/baseRouter\";\n\nexport function initializeWebSocket() {\n    // Get settings\n    const wsRelayUrl = game.settings.get(moduleId, \"wsRelayUrl\") as string;\n    const apiKey = game.settings.get(moduleId, \"apiKey\") as string;\n    const module = game.modules.get(moduleId) as FoundryRestApi;\n    \n    if (!wsRelayUrl) {\n      ModuleLogger.error(`WebSocket relay URL is empty. Please configure it in module settings.`);\n      return;\n    }\n    \n    ModuleLogger.info(`Initializing WebSocket with URL: ${wsRelayUrl}`);\n    \n    try {\n        // Create and connect the WebSocket manager - only if it doesn't exist already\n        if (!module.socketManager) {\n            module.socketManager = WebSocketManager.getInstance(wsRelayUrl, apiKey);\n            // Only attempt to connect if we got a valid instance (meaning this GM is the primary GM)\n            if (module.socketManager) {\n                module.socketManager.connect();\n            }\n        } else {\n            ModuleLogger.info(`WebSocket manager already exists, not creating a new one`);\n        }\n        \n        // If we don't have a valid socket manager, exit early\n        if (!module.socketManager) {\n            ModuleLogger.warn(`No WebSocket manager available, skipping message handler setup`);\n            return;\n        }\n        \n        // Register message handlers using routers\n        const socketManager = module.socketManager;\n        routers.forEach((router: Router) => {\n            router.reflect(socketManager);\n        });\n        \n        ModuleLogger.info(`Registered ${routers.length} routers with WebSocket manager`);\n        \n    } catch (error) {\n      ModuleLogger.error(`Error initializing WebSocket:`, error);\n    }\n}\n","import \"../styles/style.scss\";\nimport { FoundryRestApi } from \"./types\";\nimport { moduleId, recentRolls, MAX_ROLLS_STORED, CONSTANTS, SETTINGS } from \"./constants\";\nimport { ModuleLogger } from \"./utils/logger\";\nimport { initializeWebSocket } from \"./network/webSocketEndpoints\";\n\n// Declare QuickInsert interface\ndeclare global {\n  interface Window {\n    QuickInsert: {\n      open: (context: any) => void;\n      search: (text: string, filter?: ((item: any) => boolean) | null, max?: number) => Promise<any[]>;\n      forceIndex: () => void;\n      handleKeybind: (event: KeyboardEvent, context: any) => void;\n      hasIndex: boolean;\n    };\n  }\n}\n\nHooks.once(\"init\", () => {\n  console.log(`Initializing ${moduleId}`);\n  \n  for (let [name, data] of Object.entries(SETTINGS.GET_DEFAULT())) {\n    game.settings.register(CONSTANTS.MODULE_ID, name, <any>data);\n  }\n\n  // Create and expose module API\n  const module = game.modules.get(moduleId) as FoundryRestApi;\n  module.api = {\n    getWebSocketManager: () => {\n      if (!module.socketManager) {\n        ModuleLogger.warn(`WebSocketManager requested but not initialized`);\n        return null;\n      }\n      return module.socketManager;\n    },\n    search: async (query: string, filter?: string) => {\n      if (!window.QuickInsert) {\n        ModuleLogger.error(`QuickInsert not available`);\n        return [];\n      }\n      \n      if (!window.QuickInsert.hasIndex) {\n        ModuleLogger.info(`QuickInsert index not ready, forcing index creation`);\n        try {\n          window.QuickInsert.forceIndex();\n          await new Promise(resolve => setTimeout(resolve, 500));\n        } catch (error) {\n          ModuleLogger.error(`Failed to force QuickInsert index:`, error);\n        }\n      }\n      \n      let filterFunc = null;\n      if (filter) {\n        filterFunc = (item: any) => item.documentType === filter;\n      }\n      \n      return window.QuickInsert.search(query, filterFunc, 100);\n    },\n    getByUuid: async (uuid: string) => {\n      try {\n        return await fromUuid(uuid);\n      } catch (error) {\n        ModuleLogger.error(`Error getting entity by UUID:`, error);\n        return null;\n      }\n    }\n  };\n});\n\n// Replace the API key input field with a password field\nHooks.on(\"renderSettingsConfig\", (_: SettingsConfig, html: JQuery | HTMLElement) => {\n  const htmlJQuery = html instanceof HTMLElement ? $(html) : html;\n  const apiKeyInput = htmlJQuery.find(`input[name=\"${moduleId}.apiKey\"]`);\n  if (apiKeyInput.length) {\n    // Change the input type to password\n    apiKeyInput.attr(\"type\", \"password\");\n\n    // Add a button to show the client ID\n    const showClientInfoButton = $('<button type=\"button\" style=\"margin-left: 10px;\"><i class=\"fas fa-info-circle\"></i> Show Client Info</button>');\n    apiKeyInput.after(showClientInfoButton);\n\n    showClientInfoButton.on(\"click\", () => {\n      const module = game.modules.get(moduleId) as FoundryRestApi;\n      const webSocketManager = module.api.getWebSocketManager();\n      if (webSocketManager) {\n        const clientId = webSocketManager.getClientId();\n        const worldId = game.world.id;\n        const worldTitle = (game.world as any).title;\n        const foundryVersion = game.version;\n        const systemId = game.system.id;\n        const systemTitle = (game.system as any).title || game.system.id;\n        const systemVersion = (game.system as any).version || 'unknown';\n        const customName = game.settings.get(moduleId, \"customName\") as string;\n        \n        new Dialog({\n          title: \"Client Information\",\n          content: `\n            <div class=\"form-group\">\n                <label>Client ID</label>\n                <div class=\"form-fields\">\n                    <input type=\"text\" value=\"${clientId}\" readonly>\n                </div>\n            </div>\n            <div class=\"form-group\">\n                <label>World ID</label>\n                <div class=\"form-fields\">\n                    <input type=\"text\" value=\"${worldId}\" readonly>\n                </div>\n            </div>\n            <div class=\"form-group\">\n                <label>World Title</label>\n                <div class=\"form-fields\">\n                    <input type=\"text\" value=\"${worldTitle}\" readonly>\n                </div>\n            </div>\n            <div class=\"form-group\">\n                <label>Foundry Version</label>\n                <div class=\"form-fields\">\n                    <input type=\"text\" value=\"${foundryVersion}\" readonly>\n                </div>\n            </div>\n            <div class=\"form-group\">\n                <label>System ID</label>\n                <div class=\"form-fields\">\n                    <input type=\"text\" value=\"${systemId}\" readonly>\n                </div>\n            </div>\n            <div class=\"form-group\">\n                <label>System Title</label>\n                <div class=\"form-fields\">\n                    <input type=\"text\" value=\"${systemTitle}\" readonly>\n                </div>\n            </div>\n            <div class=\"form-group\">\n                <label>System Version</label>\n                <div class=\"form-fields\">\n                    <input type=\"text\" value=\"${systemVersion}\" readonly>\n                </div>\n            </div>\n            <div class=\"form-group\">\n                <label>Custom Name</label>\n                <div class=\"form-fields\">\n                    <input type=\"text\" value=\"${customName}\" readonly>\n                </div>\n            </div>\n            <p class=\"notes\">Click any field to copy its value.</p>\n          `,\n          buttons: {\n            ok: {\n              label: \"OK\"\n            }\n          },\n          render: (html: JQuery | HTMLElement) => {\n            const htmlJQuery = html instanceof HTMLElement ? $(html) : html;\n            const inputs = htmlJQuery.find('input[type=\"text\"]');\n            inputs.css('cursor', 'pointer');\n            inputs.on('click', (event: JQuery.ClickEvent) => {\n              const input = event.currentTarget;\n              navigator.clipboard.writeText(input.value).then(() => {\n                ui.notifications.info(`Copied to clipboard.`);\n                input.select();\n              });\n            });\n          }\n        }).render(true);\n      } else {\n        ui.notifications.warn(\"WebSocketManager is not available.\");\n      }\n    });\n\n    // Add an event listener to save the value when it changes\n    apiKeyInput.on(\"change\", (event) => {\n      const newValue = (event.target as HTMLInputElement).value;\n      game.settings.set(moduleId, \"apiKey\", newValue).then(() => {\n        new Dialog({\n          title: \"Reload Required\",\n          content: \"<p>The API Key has been updated. A reload is required for the changes to take effect. Would you like to reload now?</p>\",\n          buttons: {\n            yes: {\n              label: \"Reload\",\n              callback: () => window.location.reload()\n            },\n            no: {\n              label: \"Later\"\n            }\n          },\n          default: \"yes\"\n        }).render(true);\n      });\n    });\n  }\n\n  // Handle custom name changes\n  const customNameInput = htmlJQuery.find(`input[name=\"${moduleId}.customName\"]`);\n  if (customNameInput.length) {\n    customNameInput.on(\"change\", (event) => {\n      const newValue = (event.target as HTMLInputElement).value;\n      game.settings.set(moduleId, \"customName\", newValue).then(() => {\n        new Dialog({\n          title: \"Reload Required\",\n          content: \"<p>The Custom Name has been updated. A reload is required for the changes to take effect. Would you like to reload now?</p>\",\n          buttons: {\n            yes: {\n              label: \"Reload\",\n              callback: () => window.location.reload()\n            },\n            no: {\n              label: \"Later\"\n            }\n          },\n          default: \"yes\"\n        }).render(true);\n      });\n    });\n  }\n});\n\nHooks.once(\"ready\", () => {\n  setTimeout(() => {\n    initializeWebSocket();\n  }, 1000);\n});\n\nHooks.on(\"createChatMessage\", (message: any) => {\n  if (message.isRoll && message.rolls?.length > 0) {\n    ModuleLogger.info(`Detected dice roll from ${message.user?.name || 'unknown'}`);\n    \n    // Generate a unique ID using the message ID to prevent duplicates\n    const rollId = message.id;\n    \n    // Format roll data\n    const rollData = {\n      id: rollId,\n      messageId: message.id,\n      user: {\n        id: message.user?.id,\n        name: message.user?.name\n      },\n      speaker: message.speaker,\n      flavor: message.flavor || \"\",\n      rollTotal: message.rolls[0].total,\n      formula: message.rolls[0].formula,\n      isCritical: message.rolls[0].isCritical || false,\n      isFumble: message.rolls[0].isFumble || false,\n      dice: message.rolls[0].dice?.map((d: any) => ({\n        faces: d.faces,\n        results: d.results.map((r: any) => ({\n          result: r.result,\n          active: r.active\n        }))\n      })),\n      timestamp: Date.now()\n    };\n    \n    // Check if this roll ID already exists in recentRolls\n    const existingIndex = recentRolls.findIndex(roll => roll.id === rollId);\n    if (existingIndex !== -1) {\n      // If it exists, update it instead of adding a new entry\n      recentRolls[existingIndex] = rollData;\n    } else {\n      // Add to recent rolls\n      recentRolls.unshift(rollData);\n      \n      // Trim the array if needed\n      if (recentRolls.length > MAX_ROLLS_STORED) {\n        recentRolls.length = MAX_ROLLS_STORED;\n      }\n    }\n    \n    // Send to relay server if connected\n    const module = game.modules.get(moduleId) as FoundryRestApi;\n    if (module.socketManager?.isConnected()) {\n      module.socketManager.send({\n        type: \"roll-data\",\n        data: rollData\n      });\n    }\n  }\n});\n"],"names":["__publicField","system","_a","versions","a","b","version","entry","message","args","WSCloseCodes","_WebSocketManager","url","token","_b","_c","currentUserId","activeGMs","_d","u","sortedGMs","isPrimary","_e","_f","wasPrimary","wsUrl","customName","connectionTimeout","event","error","data","type","handler","_event","pingIntervalSeconds","pingIntervalMs","maxAttempts","baseDelay","delay","title","routes","route","socketManager","router","context","entity","serialized","attrKey","attrValue","subKey","subValue","propKey","key","value","itemCollection","i","itemEntries","_","item","err","effectCollection","effectEntries","effect","entityData","entityUUID","controlledTokens","DocumentClass","createData","entities","results","currentValue","newValue","updateData","updatedEntities","e","success","actor","combat","combatant","c","deadEffect","tokensUpdated","scenes","tokens","t","combatants","fromEntity","toEntity","itemEntity","itemData","resolve","itemSearchResult","r","foundItem","amountToGive","existingItem","isStackable","sourceQuantity","newItemId","finalQuantity","newQuantity","amountToRemove","currentQuantity","encounters","tokensData","uuid","addedTokenIds","currentScene","tokenData","selectedTokens","encounterId","addedEntities","failedEntities","combatantData","scene","tokenForActor","removedEntities","combatantIdsToRemove","foundCombatant","validIds","id","formula","flavor","createChatMessage","speaker","whisper","requestId","rollResult","speakerData","rollMode","speakerEntity","activeScene","roll","term","result","d","filterStr","filters","parts","part","itemConstructorName","packageValue","folderValue","folderIdMatch","propertyValue","current","filterFunc","filteredResults","includeEntityData","path","recursive","recursiveDepth","types","typeCollectionMap","getEntityData","buildFolderStructure","parentFolder","currentDepth","structure","childFolders","f","folder","folderKey","folderEntities","pack","folderMatch","folderId","startFolder","folders","typeFolders","rootEntities","collection","compendiumPacks","packKey","contents","folderData","deleteAll","entitiesDeleted","foldersDeleted","recursiveDelete","folderToDelete","entityCount","folderCount","childFolder","childCounts","entitiesToDelete","counts","sheet","extractClassesAndIds","element","className","classNames","ids","html","css","sheetAppId","style","tempDiv","uniqueClassNames","uniqueIds","allStyles","allLinks","styleContent","stylesheetPromises","link","href","fullUrl","response","baseUrl","coreStylesheets","existingCSSPaths","corePromises","allPromises","match","src","renderError","macros","macro","executionError","errorMessage","targetSet","actorKey","targets","_g","selectedUuids","source","dirs","dir","files","file","subdirs","subResult","subDirs","subdir","subFiles","subDir","deepResult","deepDirs","deepdir","deepFiles","deepError","filename","fileData","mimeType","binaryData","overwrite","bytes","blob","base64Data","binaryString","uploadSource","directories","currentPath","directory","createDirError","existingFile","filePath","uploadedPath","reader","reject","actorUuid","details","itemUuid","itemName","amount","uses","currentSpent","maxUses","newSpent","updatePayload","useAbilityHandler","abilityType","actionType","abilityUuid","abilityName","targetUuid","ability","targetToken","targetDoc","tokenObject","useResult","selected","currentXp","newXp","PingPongRouter","EntityRouter","EncounterRouter","RollRouter","SearchRouter","StructureRouter","SheetRouter","MacroRouter","UtilityRouter","FileSystemRouter","Dnd5eRouter","wsRelayUrl","apiKey","module","name","query","filter","htmlJQuery","apiKeyInput","showClientInfoButton","webSocketManager","clientId","worldId","worldTitle","foundryVersion","systemId","systemTitle","systemVersion","inputs","input","customNameInput","rollId","rollData","existingIndex"],"mappings":"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"}